# =============================================================================
# üöÄ Deploy to Production Template
# =============================================================================
# Copy this file to your project's .github/workflows/ directory
# and customize for your specific deployment needs.
#
# Prerequisites:
# 1. Run the "Server Setup & CI/CD" workflow first to set up your server
# 2. Add these secrets to your repository:
#    - TAILSCALE_OAUTH_CLIENT_ID: Tailscale OAuth Client ID
#    - TAILSCALE_OAUTH_SECRET: Tailscale OAuth Secret
#    - PROD_SSH_KEY: SSH private key for 'actions' user
#    - PROD_SSH_PORT: SSH port (usually 22)
#    - PROD_SSH_USER: SSH username (usually 'actions')
#
# Optional secrets for predefined servers:
#    - PROD_TAILSCALE_IP: Default production server IP
#    - STAGING_TAILSCALE_IP: Staging server IP
#    - DEV_TAILSCALE_IP: Development server IP
# =============================================================================

name: üöÄ Deploy to Production

on:
    workflow_dispatch:
        inputs:
            target_server:
                description: "üñ•Ô∏è Target Server"
                required: true
                type: choice
                default: "production"
                options:
                    - production
                    - staging
                    - development
                    - custom
            custom_tailscale_ip:
                description: "üîó Custom Tailscale IP (only if 'custom' selected above)"
                required: false
                type: string
                default: ""
            skip_tests:
                description: "‚è≠Ô∏è Skip tests and deploy directly"
                required: false
                type: boolean
                default: false
            dry_run:
                description: "üß™ Dry run (show what would be deployed without executing)"
                required: false
                type: boolean
                default: false

# Customize these for your project
env:
    PROJECT_NAME: my-project # Change this to your repo name
    DEPLOY_PATH: /home/actions # Repos are cloned to /home/actions/<repo-name>

concurrency:
    group: deploy-${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: false

defaults:
    run:
        shell: bash

jobs:
    # ========================================================================
    # STAGE 1: Resolve Target Server
    # ========================================================================
    resolve-target:
        name: üîç Resolve Target Server
        runs-on: ubuntu-latest
        outputs:
            tailscale_ip: ${{ steps.resolve.outputs.tailscale_ip }}
            server_name: ${{ steps.resolve.outputs.server_name }}
        steps:
            - name: üéØ Resolve Target Tailscale IP
              id: resolve
              run: |
                  TARGET="${{ inputs.target_server }}"
                  CUSTOM_IP="${{ inputs.custom_tailscale_ip }}"

                  echo "üîç Resolving target server: $TARGET"

                  case "$TARGET" in
                    production)
                      IP="${{ secrets.PROD_TAILSCALE_IP }}"
                      SERVER_NAME="Production"
                      ;;
                    staging)
                      IP="${{ secrets.STAGING_TAILSCALE_IP }}"
                      SERVER_NAME="Staging"
                      ;;
                    development)
                      IP="${{ secrets.DEV_TAILSCALE_IP }}"
                      SERVER_NAME="Development"
                      ;;
                    custom)
                      IP="$CUSTOM_IP"
                      SERVER_NAME="Custom ($CUSTOM_IP)"
                      ;;
                    *)
                      echo "‚ùå Unknown target: $TARGET"
                      exit 1
                      ;;
                  esac

                  # Validate IP is set
                  if [ -z "$IP" ]; then
                    echo "‚ùå No Tailscale IP configured for target: $TARGET"
                    echo ""
                    echo "Please either:"
                    echo "  1. Add the appropriate secret (PROD_TAILSCALE_IP, STAGING_TAILSCALE_IP, or DEV_TAILSCALE_IP)"
                    echo "  2. Select 'custom' and provide a Tailscale IP in the input field"
                    exit 1
                  fi

                  # Basic IP format validation (Tailscale IPs are 100.x.x.x)
                  if [[ ! "$IP" =~ ^100\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                    echo "‚ö†Ô∏è Warning: IP '$IP' doesn't match typical Tailscale format (100.x.x.x)"
                    echo "   Proceeding anyway, but verify this is correct."
                  fi

                  echo "‚úÖ Target resolved: $SERVER_NAME ‚Üí $IP"
                  echo "tailscale_ip=$IP" >> $GITHUB_OUTPUT
                  echo "server_name=$SERVER_NAME" >> $GITHUB_OUTPUT

    # ========================================================================
    # STAGE 2: Build & Test (Optional)
    # ========================================================================
    # test:
    #     name: üß™ Run Tests
    #     runs-on: ubuntu-latest
    #     if: ${{ !inputs.skip_tests }}
    #     steps:
    #         - uses: actions/checkout@v4
    #         - name: Run tests
    #           run: |
    #               # Add your test commands here
    #               echo "Running tests..."

    # ========================================================================
    # STAGE 3: Deploy to Production
    # ========================================================================
    deploy:
        name: üöÄ Deploy to ${{ needs.resolve-target.outputs.server_name }}
        runs-on: ubuntu-latest
        needs: resolve-target
        timeout-minutes: 30
        # needs: [resolve-target, test]  # Uncomment if using test job
        environment:
            name: ${{ inputs.target_server }}
            # url: https://your-domain.com  # Uncomment and set your URL

        steps:
            - name: üìã Deployment Info
              run: |
                  echo "## üöÄ Deployment Configuration" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Target Server | \`${{ needs.resolve-target.outputs.server_name }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| Tailscale IP | \`${{ needs.resolve-target.outputs.tailscale_ip }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| Project | \`${{ env.PROJECT_NAME }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| Dry Run | \`${{ inputs.dry_run }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| Skip Tests | \`${{ inputs.skip_tests }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

            - name: üì• Checkout code
              uses: actions/checkout@v4

            - name: üîå Connect to Tailscale
              uses: tailscale/github-action@v2
              with:
                  oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
                  tags: tag:ci

            - name: üì° Verify Tailscale Connection
              run: |
                  sleep 3
                  echo "Tailscale IP: $(tailscale ip -4)"
                  echo "Target server: ${{ needs.resolve-target.outputs.tailscale_ip }} (${{ needs.resolve-target.outputs.server_name }})"

                  # Test connectivity to target
                  if tailscale ping --c 3 "${{ needs.resolve-target.outputs.tailscale_ip }}" > /dev/null 2>&1; then
                    echo "‚úÖ Target server is reachable via Tailscale"
                  else
                    echo "‚ö†Ô∏è Could not ping target, but proceeding (ping may be disabled)"
                  fi

            - name: üîë Setup SSH via Tailscale
              run: |
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh

                  # Write SSH private key
                  echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/id_rsa
                  chmod 600 ~/.ssh/id_rsa

                  # Verify key format
                  if ! head -1 ~/.ssh/id_rsa | grep -q "BEGIN"; then
                    echo "‚ùå SSH key is malformed"
                    exit 1
                  fi

                  # Add server to known hosts
                  ssh-keyscan -p ${{ secrets.PROD_SSH_PORT || '22' }} ${{ needs.resolve-target.outputs.tailscale_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

                  echo "‚úÖ SSH configured"

            - name: üîç Test SSH Connection
              run: |
                  TARGET_IP="${{ needs.resolve-target.outputs.tailscale_ip }}"
                  SSH_PORT="${{ secrets.PROD_SSH_PORT || '22' }}"
                  SSH_USER="${{ secrets.PROD_SSH_USER || 'actions' }}"

                  echo "üîç Testing SSH to $SSH_USER@$TARGET_IP:$SSH_PORT..."

                  ssh -o BatchMode=yes \
                      -o ConnectTimeout=10 \
                      -o StrictHostKeyChecking=no \
                      -p $SSH_PORT \
                      $SSH_USER@$TARGET_IP \
                      "echo '‚úÖ SSH connection successful' && hostname && echo 'Uptime:' && uptime"

            - name: üß™ Dry Run - Show What Would Be Deployed
              if: ${{ inputs.dry_run }}
              run: |
                  echo "üß™ DRY RUN MODE - No changes will be made"
                  echo ""
                  echo "üì¶ Files that would be synced:"
                  find . -type f \
                    ! -path './.git/*' \
                    ! -path './.github/*' \
                    ! -path './node_modules/*' \
                    ! -path './__pycache__/*' \
                    ! -name '.env.local' \
                    ! -name '.env.development' \
                    ! -name '*.log' \
                    | head -50

                  echo ""
                  echo "üìä Total files: $(find . -type f ! -path './.git/*' ! -path './node_modules/*' | wc -l)"
                  echo ""
                  echo "üéØ Would deploy to: ${{ needs.resolve-target.outputs.server_name }} (${{ needs.resolve-target.outputs.tailscale_ip }})"
                  echo "üìÅ Deploy path: ${{ env.DEPLOY_PATH }}/${{ env.PROJECT_NAME }}/"

                  echo "## üß™ Dry Run Complete" >> $GITHUB_STEP_SUMMARY
                  echo "No changes were made. Review the logs above to see what would be deployed." >> $GITHUB_STEP_SUMMARY

            - name: üì§ Sync Code to Server
              if: ${{ !inputs.dry_run }}
              run: |
                  TARGET_IP="${{ needs.resolve-target.outputs.tailscale_ip }}"
                  SSH_PORT="${{ secrets.PROD_SSH_PORT || '22' }}"
                  SSH_USER="${{ secrets.PROD_SSH_USER || 'actions' }}"

                  echo "üì§ Syncing code to $TARGET_IP (${{ needs.resolve-target.outputs.server_name }})..."

                  rsync -avz --delete \
                    --exclude '.git' \
                    --exclude '.github' \
                    --exclude 'node_modules' \
                    --exclude '__pycache__' \
                    --exclude '.env.local' \
                    --exclude '.env.development' \
                    --exclude '*.log' \
                    -e "ssh -o StrictHostKeyChecking=no -p $SSH_PORT" \
                    ./ $SSH_USER@$TARGET_IP:${{ env.DEPLOY_PATH }}/${{ env.PROJECT_NAME }}/

                  echo "‚úÖ Code synced"

            - name: üöÄ Run Deployment
              if: ${{ !inputs.dry_run }}
              env:
                  TARGET_IP: ${{ needs.resolve-target.outputs.tailscale_ip }}
                  SSH_PORT: ${{ secrets.PROD_SSH_PORT || '22' }}
                  SSH_USER: ${{ secrets.PROD_SSH_USER || 'actions' }}
                  DEPLOY_DIR: ${{ env.DEPLOY_PATH }}/${{ env.PROJECT_NAME }}
              run: |
                  ssh -o StrictHostKeyChecking=no \
                      -p $SSH_PORT \
                      $SSH_USER@$TARGET_IP << DEPLOY_SCRIPT

                  set -e
                  cd $DEPLOY_DIR

                  echo "üìã Deploying from: \$(pwd)"
                  echo "üìã Git info: \$(git rev-parse HEAD 2>/dev/null || echo 'Not a git repo')"

                  # =============================================================
                  # CUSTOMIZE YOUR DEPLOYMENT BELOW
                  # =============================================================

                  # Option 1: Docker Compose deployment
                  if [ -f "docker-compose.yml" ] || [ -f "compose.yml" ]; then
                    echo "üê≥ Docker Compose detected"
                    docker compose pull 2>/dev/null || true
                    docker compose up -d --build --remove-orphans
                    docker compose ps
                  fi

                  # Option 2: Node.js deployment (uncomment if needed)
                  # if [ -f "package.json" ]; then
                  #   echo "üì¶ Node.js detected"
                  #   npm ci --production
                  #   pm2 restart ecosystem.config.js --env production 2>/dev/null || \
                  #     pm2 start ecosystem.config.js --env production
                  # fi

                  # Option 3: Python deployment (uncomment if needed)
                  # if [ -f "requirements.txt" ]; then
                  #   echo "üêç Python detected"
                  #   source venv/bin/activate 2>/dev/null || python3 -m venv venv && source venv/bin/activate
                  #   pip install -r requirements.txt
                  #   sudo systemctl restart myapp
                  # fi

                  # Option 4: Custom run script (uncomment if needed)
                  # if [ -f "run.sh" ]; then
                  #   echo "üîß Running custom run.sh"
                  #   chmod +x run.sh
                  #   ./run.sh deploy
                  # fi

                  echo "‚úÖ Deployment complete!"

                  DEPLOY_SCRIPT

            - name: üè• Health Check
              if: ${{ !inputs.dry_run }}
              env:
                  TARGET_IP: ${{ needs.resolve-target.outputs.tailscale_ip }}
                  SSH_PORT: ${{ secrets.PROD_SSH_PORT || '22' }}
                  SSH_USER: ${{ secrets.PROD_SSH_USER || 'actions' }}
                  DEPLOY_DIR: ${{ env.DEPLOY_PATH }}/${{ env.PROJECT_NAME }}
              run: |
                  echo "üè• Running health check..."

                  ssh -o StrictHostKeyChecking=no \
                      -p $SSH_PORT \
                      $SSH_USER@$TARGET_IP << HEALTH_CHECK

                  cd $DEPLOY_DIR

                  # Check Docker containers if using Docker
                  if command -v docker &> /dev/null; then
                    echo "üê≥ Docker containers:"
                    docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || true
                  fi

                  # System resources
                  echo ""
                  echo "üìä System resources:"
                  echo "  Memory: \$(free -h | awk '/^Mem:/ {print \$3 "/" \$2}')"
                  echo "  Disk: \$(df -h / | awk 'NR==2 {print \$3 "/" \$2 " (" \$5 " used)"}')"
                  echo "  Load: \$(uptime | awk -F'load average:' '{print \$2}')"

                  HEALTH_CHECK

            - name: üìä Deployment Summary
              if: always()
              env:
                  TARGET_IP: ${{ needs.resolve-target.outputs.tailscale_ip }}
                  SERVER_NAME: ${{ needs.resolve-target.outputs.server_name }}
                  SSH_PORT: ${{ secrets.PROD_SSH_PORT || '22' }}
                  SSH_USER: ${{ secrets.PROD_SSH_USER || 'actions' }}
              run: |
                  if [ "${{ inputs.dry_run }}" != "true" ]; then
                    cat >> $GITHUB_STEP_SUMMARY << EOF
                  ## üöÄ Deployment Summary

                  | Property | Value |
                  |----------|-------|
                  | Server | \`$SERVER_NAME\` |
                  | Tailscale IP | \`$TARGET_IP\` |
                  | Project | \`${{ env.PROJECT_NAME }}\` |
                  | Path | \`${{ env.DEPLOY_PATH }}/${{ env.PROJECT_NAME }}\` |
                  | Branch | \`${{ github.ref_name }}\` |
                  | Commit | \`${{ github.sha }}\` |
                  | Triggered by | \`${{ github.actor }}\` |
                  | Status | ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |

                  ### Quick Commands

                  \`\`\`bash
                  # SSH into server
                  ssh -p $SSH_PORT $SSH_USER@$TARGET_IP

                  # Go to project
                  cd ${{ env.DEPLOY_PATH }}/${{ env.PROJECT_NAME }}

                  # View logs (if using Docker)
                  docker compose logs -f
                  \`\`\`
                  EOF
                  fi

            - name: üßπ Cleanup
              if: always()
              run: |
                  rm -f ~/.ssh/id_rsa
                  echo "‚úÖ Cleanup complete"
