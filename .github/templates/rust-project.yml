# =============================================================================
# ðŸ¦€ Rust Project CI/CD Pipeline Template
# =============================================================================
# A complete CI/CD workflow for Rust projects using reusable actions.
#
# SETUP:
# 1. Copy this file to your repository: .github/workflows/ci-cd.yml
# 2. Customize the env variables below for your project
# 3. Add required secrets to your repository (see secrets section below)
#
# REQUIRED SECRETS:
#   - DOCKER_USERNAME: Docker Hub username
#   - DOCKER_TOKEN: Docker Hub access token
#
# OPTIONAL SECRETS (for deployment):
#   - TAILSCALE_OAUTH_CLIENT_ID: Tailscale OAuth Client ID
#   - TAILSCALE_OAUTH_SECRET: Tailscale OAuth Secret
#   - PROD_TAILSCALE_IP: Production server Tailscale IP (100.x.x.x)
#   - PROD_SSH_KEY: SSH private key for deployment user
#   - PROD_SSH_USER: SSH username (default: actions)
#   - PROD_SSH_PORT: SSH port (default: 22)
#
# OPTIONAL SECRETS (for notifications):
#   - DISCORD_WEBHOOK: Discord webhook URL for notifications
#   - CODECOV_TOKEN: Codecov upload token for coverage reports
# =============================================================================

name: ðŸ¦€ CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - ".gitignore"
      - "LICENSE"
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      skip_tests:
        description: "Skip tests (deploy only)"
        required: false
        type: boolean
        default: false
      deploy_env:
        description: "Deployment environment"
        required: false
        type: choice
        options:
          - none
          - staging
          - production
        default: none

# =============================================================================
# CUSTOMIZE THESE FOR YOUR PROJECT
# =============================================================================
env:
  # Project settings
  PROJECT_NAME: my-rust-project          # Your project name
  RUST_VERSION: stable                    # Rust toolchain version

  # Docker settings (set to empty string to skip Docker build)
  DOCKER_IMAGE: myuser/my-rust-project   # Docker image name (user/repo)
  DOCKERFILE_PATH: Dockerfile             # Path to Dockerfile
  DOCKER_PLATFORMS: linux/amd64,linux/arm64  # Target platforms

  # Deployment settings
  DEPLOY_PATH: ~/my-rust-project         # Path on server
  COMPOSE_FILE: docker-compose.yml       # Docker compose file

  # CI settings
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

# =============================================================================
# WORKFLOW CONFIGURATION
# =============================================================================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write
  checks: write

defaults:
  run:
    shell: bash

# =============================================================================
# JOBS
# =============================================================================
jobs:
  # ===========================================================================
  # Stage 1: Code Quality & Tests
  # ===========================================================================
  test:
    name: ðŸ§ª Test & Lint
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: ${{ !inputs.skip_tests }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“£ Notify build started
        if: ${{ secrets.DISCORD_WEBHOOK != '' }}
        uses: nuniesmith/actions/.github/actions/discord-notify@main
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ðŸ”¨ CI Pipeline Started"
          description: "Running tests for `${{ env.PROJECT_NAME }}`"
          status: started
          include-repo-info: "true"

      - name: ðŸ¦€ Run Rust CI
        id: rust-ci
        uses: nuniesmith/actions/.github/actions/rust-ci@main
        with:
          toolchain: ${{ env.RUST_VERSION }}
          run-fmt: "true"
          run-clippy: "true"
          run-tests: "true"
          run-build: "true"
          build-release: "true"
          coverage: "true"
          # Customize clippy strictness:
          # clippy-args: "--all-targets --all-features -- -D warnings"

      - name: ðŸ“Š Upload coverage to Codecov
        if: ${{ hashFiles('./coverage/cobertura.xml') != '' && secrets.CODECOV_TOKEN != '' }}
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/cobertura.xml
          flags: unittests
          name: ${{ env.PROJECT_NAME }}
          fail_ci_if_error: false

      - name: âœ… Notify tests passed
        if: ${{ success() && secrets.DISCORD_WEBHOOK != '' }}
        uses: nuniesmith/actions/.github/actions/discord-notify@main
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âœ… Tests Passed"
          description: "All tests passed for `${{ env.PROJECT_NAME }}`"
          status: success
          include-repo-info: "true"

      - name: âŒ Notify tests failed
        if: ${{ failure() && secrets.DISCORD_WEBHOOK != '' }}
        uses: nuniesmith/actions/.github/actions/discord-notify@main
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âŒ Tests Failed"
          description: "CI tests failed. Check the logs for details."
          status: failure
          fields: '[{"name": "Workflow", "value": "[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}]'

  # ===========================================================================
  # Stage 2: Security Audit
  # ===========================================================================
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ !inputs.skip_tests }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ¦€ Setup Rust
        uses: nuniesmith/actions/.github/actions/setup-rust@main
        with:
          rust-version: ${{ env.RUST_VERSION }}
          cache-key-suffix: security

      - name: ðŸ”’ Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: ðŸ” Run security audit
        run: |
          echo "ðŸ”’ Running cargo audit..."
          cargo audit --json > audit-results.json 2>&1 || true

          # Parse results
          if [ -f audit-results.json ]; then
            VULNS=$(jq '.vulnerabilities.count // 0' audit-results.json 2>/dev/null || echo "0")
            if [ "$VULNS" -gt 0 ]; then
              echo "âš ï¸ Found $VULNS vulnerabilities"
              cargo audit
              # Uncomment to fail on vulnerabilities:
              # exit 1
            else
              echo "âœ… No known vulnerabilities found"
            fi
          fi

      - name: ðŸ“¦ Check for outdated dependencies
        run: |
          cargo install cargo-outdated --locked || true
          echo "ðŸ“¦ Checking for outdated dependencies..."
          cargo outdated --root-deps-only || true

  # ===========================================================================
  # Stage 3: Build Docker Image
  # ===========================================================================
  docker:
    name: ðŸ³ Build Docker Image
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: [test, security]
    if: |
      always() &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.security.result == 'success' || needs.security.result == 'skipped') &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'

    outputs:
      image-digest: ${{ steps.docker.outputs.digest }}
      image-tags: ${{ steps.docker.outputs.tags }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Build and Push Docker Image
        id: docker
        if: ${{ env.DOCKER_IMAGE != '' }}
        uses: nuniesmith/actions/.github/actions/docker-build-push@main
        with:
          image-name: ${{ env.DOCKER_IMAGE }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
          dockerfile: ${{ env.DOCKERFILE_PATH }}
          platforms: ${{ env.DOCKER_PLATFORMS }}
          push: "true"

      - name: ðŸ“ Skip Docker (not configured)
        if: ${{ env.DOCKER_IMAGE == '' }}
        run: echo "Docker build skipped - DOCKER_IMAGE not configured"

      - name: âœ… Notify Docker build complete
        if: ${{ success() && env.DOCKER_IMAGE != '' && secrets.DISCORD_WEBHOOK != '' }}
        uses: nuniesmith/actions/.github/actions/discord-notify@main
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ðŸ³ Docker Image Built"
          description: "Multi-arch images pushed to Docker Hub"
          status: success
          fields: '[{"name": "Image", "value": "`${{ env.DOCKER_IMAGE }}`", "inline": true}, {"name": "Platforms", "value": "`${{ env.DOCKER_PLATFORMS }}`", "inline": true}]'

  # ===========================================================================
  # Stage 4: Deploy to Production
  # ===========================================================================
  deploy:
    name: ðŸš€ Deploy to Production
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: docker
    if: |
      always() &&
      (needs.docker.result == 'success' || needs.docker.result == 'skipped') &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      vars.ENABLE_DEPLOY == 'true'
    environment:
      name: production
      # url: https://your-domain.com  # Uncomment and set your URL

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”Œ Connect to Tailscale
        uses: nuniesmith/actions/.github/actions/tailscale-connect@main
        with:
          oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
          target-ip: ${{ secrets.PROD_TAILSCALE_IP }}
          target-ssh-port: ${{ secrets.PROD_SSH_PORT || '22' }}

      - name: ðŸš€ Deploy via SSH
        uses: nuniesmith/actions/.github/actions/ssh-deploy@main
        with:
          host: ${{ secrets.PROD_TAILSCALE_IP }}
          port: ${{ secrets.PROD_SSH_PORT || '22' }}
          username: ${{ secrets.PROD_SSH_USER || 'actions' }}
          ssh-key: ${{ secrets.PROD_SSH_KEY }}
          project-path: ${{ env.DEPLOY_PATH }}
          docker-compose-file: ${{ env.COMPOSE_FILE }}
          git-pull: "true"
          git-branch: main
          docker-pull: "true"
          docker-prune: "true"

      - name: âœ… Notify deployment success
        if: ${{ success() && secrets.DISCORD_WEBHOOK != '' }}
        uses: nuniesmith/actions/.github/actions/discord-notify@main
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          title: "ðŸš€ Deployment Successful"
          description: "`${{ env.PROJECT_NAME }}` deployed to production"
          status: success
          fields: |
            [
              {"name": "Version", "value": "`${{ github.sha }}`", "inline": true},
              {"name": "Branch", "value": "`${{ github.ref_name }}`", "inline": true},
              {"name": "Triggered by", "value": "`${{ github.actor }}`", "inline": true}
            ]

      - name: âŒ Notify deployment failed
        if: ${{ failure() && secrets.DISCORD_WEBHOOK != '' }}
        uses: nuniesmith/actions/.github/actions/discord-notify@main
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          title: "âŒ Deployment Failed"
          description: "Failed to deploy `${{ env.PROJECT_NAME }}`"
          status: failure
          fields: '[{"name": "Logs", "value": "[View Workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": false}]'

  # ===========================================================================
  # Stage 5: Pipeline Summary
  # ===========================================================================
  summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [test, security, docker, deploy]
    if: always()

    steps:
      - name: ðŸ“Š Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ¦€ CI/CD Pipeline Summary

          | Stage | Status |
          |-------|--------|
          | ðŸ§ª Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || needs.test.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |
          | ðŸ”’ Security | ${{ needs.security.result == 'success' && 'âœ… Passed' || needs.security.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |
          | ðŸ³ Docker | ${{ needs.docker.result == 'success' && 'âœ… Built' || needs.docker.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |
          | ðŸš€ Deploy | ${{ needs.deploy.result == 'success' && 'âœ… Deployed' || needs.deploy.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |

          ### Build Info

          | Property | Value |
          |----------|-------|
          | Project | `${{ env.PROJECT_NAME }}` |
          | Branch | `${{ github.ref_name }}` |
          | Commit | `${{ github.sha }}` |
          | Triggered by | `${{ github.actor }}` |
          | Event | `${{ github.event_name }}` |
          EOF

      - name: âŒ Fail if critical stages failed
        if: |
          needs.test.result == 'failure' ||
          needs.docker.result == 'failure'
        run: |
          echo "âŒ Pipeline failed due to critical stage failure"
          exit 1
