name: "SSL Certificate Check"
description: "Check existing SSL certificates on a remote server â€” supports Docker volumes, host filesystem, and best-cert selection across multiple locations"
author: "nuniesmith"

branding:
    icon: "shield"
    color: "green"

inputs:
    ssh-host:
        description: "SSH host to check certificates on"
        required: true
    ssh-port:
        description: "SSH port"
        required: false
        default: "22"
    ssh-user:
        description: "SSH username"
        required: false
        default: "actions"
    ssh-key:
        description: "SSH private key for regular user"
        required: true
    domain:
        description: "Domain name to check certificate for"
        required: true
    docker-volume-name:
        description: "Docker volume name to check for certificates (e.g., fks_ssl_certs). If empty, Docker volume check is skipped."
        required: false
        default: ""
    docker-volume-cert-path:
        description: "Path to certificate INSIDE the Docker volume container mount. Supports {domain} placeholder."
        required: false
        default: "live/{domain}/fullchain.pem"
    host-cert-path:
        description: "Path to certificate on the host filesystem. Supports {domain} placeholder."
        required: false
        default: "/etc/letsencrypt/live/{domain}/fullchain.pem"
    check-host-path:
        description: "Whether to also check the host filesystem path"
        required: false
        default: "true"
    use-sudo:
        description: "Whether to use sudo when reading host filesystem certificates"
        required: false
        default: "true"
    renewal-threshold-days:
        description: "Days before expiry to consider renewal needed (LE certs are 90 days; 27 = 70/30 overlap rule)"
        required: false
        default: "27"

outputs:
    cert-exists:
        description: "Whether a valid certificate was found in any location"
        value: ${{ steps.select.outputs.cert_exists }}
    cert-type:
        description: "Certificate type (letsencrypt, self-signed, none, unknown)"
        value: ${{ steps.select.outputs.cert_type }}
    days-remaining:
        description: "Days until certificate expiry"
        value: ${{ steps.select.outputs.days_remaining }}
    expiry-date:
        description: "Certificate expiry date string"
        value: ${{ steps.select.outputs.expiry_date }}
    needs-renewal:
        description: "Whether the certificate needs renewal"
        value: ${{ steps.select.outputs.needs_renewal }}
    skip-generation:
        description: "Whether SSL generation should be skipped (valid LE cert exists above threshold)"
        value: ${{ steps.select.outputs.skip_generation }}
    issuer:
        description: "Certificate issuer"
        value: ${{ steps.select.outputs.issuer }}
    cert-source:
        description: "Which location had the best certificate (docker-volume, host-filesystem, none)"
        value: ${{ steps.select.outputs.cert_source }}

runs:
    using: "composite"
    steps:
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # SSH SETUP
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - name: ðŸ” Setup SSH
          id: ssh-setup
          shell: bash
          env:
              SSH_KEY: ${{ inputs.ssh-key }}
              SSH_HOST: ${{ inputs.ssh-host }}
              SSH_PORT: ${{ inputs.ssh-port }}
          run: |
              mkdir -p ~/.ssh
              chmod 700 ~/.ssh
              echo "$SSH_KEY" > ~/.ssh/ssl_check_key
              chmod 600 ~/.ssh/ssl_check_key

              ssh-keyscan -p "$SSH_PORT" "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

              echo "ssh_ready=true" >> $GITHUB_OUTPUT

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # CHECK DOCKER VOLUME
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - name: ðŸ“¦ Check Docker Volume Certificate
          id: check-volume
          if: inputs.docker-volume-name != ''
          shell: bash
          env:
              SSH_HOST: ${{ inputs.ssh-host }}
              SSH_PORT: ${{ inputs.ssh-port }}
              SSH_USER: ${{ inputs.ssh-user }}
              DOMAIN: ${{ inputs.domain }}
              VOLUME_NAME: ${{ inputs.docker-volume-name }}
              VOLUME_CERT_PATH_TEMPLATE: ${{ inputs.docker-volume-cert-path }}
              RENEWAL_THRESHOLD: ${{ inputs.renewal-threshold-days }}
          run: |
              VOLUME_CERT_PATH=$(echo "$VOLUME_CERT_PATH_TEMPLATE" | sed "s/{domain}/$DOMAIN/g")
              echo "ðŸ“¦ Checking Docker volume ($VOLUME_NAME) at /certs/$VOLUME_CERT_PATH ..."

              # Test SSH connectivity first
              if ! ssh -i ~/.ssh/ssl_check_key -p "$SSH_PORT" -o ConnectTimeout=10 -o BatchMode=yes "$SSH_USER@$SSH_HOST" "echo 'SSH OK'" 2>&1; then
                echo "âš ï¸ SSH connection failed â€” cannot check Docker volume"
                echo "vol_exists=false"   >> $GITHUB_OUTPUT
                echo "vol_type=unknown"   >> $GITHUB_OUTPUT
                echo "vol_days=0"         >> $GITHUB_OUTPUT
                echo "vol_expiry="        >> $GITHUB_OUTPUT
                echo "vol_issuer=unknown" >> $GITHUB_OUTPUT
                exit 0
              fi

              # Read cert metadata from inside the volume via a disposable container
              VOLUME_CERT=$(ssh -i ~/.ssh/ssl_check_key \
                -p "$SSH_PORT" \
                -o StrictHostKeyChecking=no \
                -o BatchMode=yes \
                "$SSH_USER@$SSH_HOST" \
                "docker run --rm -v ${VOLUME_NAME}:/certs:ro alpine/openssl x509 \
                  -in /certs/${VOLUME_CERT_PATH} \
                  -noout -subject -enddate -issuer -checkend 0 2>/dev/null" 2>/dev/null) || true

              if [ -z "$VOLUME_CERT" ]; then
                echo "   âŒ No certificate found in Docker volume"
                echo "vol_exists=false"   >> $GITHUB_OUTPUT
                echo "vol_type=none"      >> $GITHUB_OUTPUT
                echo "vol_days=0"         >> $GITHUB_OUTPUT
                echo "vol_expiry="        >> $GITHUB_OUTPUT
                echo "vol_issuer=none"    >> $GITHUB_OUTPUT
                exit 0
              fi

              echo "vol_exists=true" >> $GITHUB_OUTPUT

              # â”€â”€ Parse issuer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              VOL_ISSUER=$(echo "$VOLUME_CERT" | grep -i "issuer" || echo "unknown")
              echo "vol_issuer=$VOL_ISSUER" >> $GITHUB_OUTPUT

              if echo "$VOL_ISSUER" | grep -qi "Let's Encrypt\|R3\|R10\|R11\|E5\|E6\|E1\|E2\|ISRG"; then
                VOL_TYPE="letsencrypt"
              else
                VOL_TYPE="self-signed"
              fi
              echo "vol_type=$VOL_TYPE" >> $GITHUB_OUTPUT

              # â”€â”€ Parse expiry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              VOL_EXPIRY=$(echo "$VOLUME_CERT" | grep "notAfter" | cut -d= -f2)
              echo "vol_expiry=$VOL_EXPIRY" >> $GITHUB_OUTPUT

              if [ -n "$VOL_EXPIRY" ]; then
                VOL_EXPIRY_EPOCH=$(ssh -i ~/.ssh/ssl_check_key \
                  -p "$SSH_PORT" \
                  -o StrictHostKeyChecking=no \
                  -o BatchMode=yes \
                  "$SSH_USER@$SSH_HOST" \
                  "docker run --rm -v ${VOLUME_NAME}:/certs:ro alpine/openssl x509 \
                    -in /certs/${VOLUME_CERT_PATH} \
                    -noout -enddate 2>/dev/null \
                    | cut -d= -f2 \
                    | xargs -I{} date -d '{}' +%s 2>/dev/null || echo 0" 2>/dev/null) || true
                NOW_EPOCH=$(date +%s)
                if [ -n "$VOL_EXPIRY_EPOCH" ] && [ "$VOL_EXPIRY_EPOCH" -gt 0 ] 2>/dev/null; then
                  VOL_DAYS=$(( (VOL_EXPIRY_EPOCH - NOW_EPOCH) / 86400 ))
                else
                  VOL_DAYS=0
                fi
              else
                VOL_DAYS=0
              fi
              echo "vol_days=$VOL_DAYS" >> $GITHUB_OUTPUT

              # â”€â”€ Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              echo "   Type:           $VOL_TYPE"
              echo "   Expires:        $VOL_EXPIRY"
              echo "   Days remaining: $VOL_DAYS"

              if [ "$VOL_TYPE" = "letsencrypt" ] && [ "$VOL_DAYS" -gt "$RENEWAL_THRESHOLD" ]; then
                echo "   âœ… Certificate is healthy ($VOL_DAYS days > $RENEWAL_THRESHOLD threshold)"
              elif [ "$VOL_TYPE" = "letsencrypt" ] && [ "$VOL_DAYS" -gt 0 ]; then
                echo "   âš ï¸  Certificate approaching expiry ($VOL_DAYS days â‰¤ $RENEWAL_THRESHOLD threshold)"
              elif [ "$VOL_TYPE" = "self-signed" ] && [ "$VOL_DAYS" -gt 0 ]; then
                echo "   â„¹ï¸  Self-signed cert found ($VOL_DAYS days remaining)"
              else
                echo "   âŒ Certificate is expired or invalid"
              fi

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # CHECK HOST FILESYSTEM
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - name: ðŸ–¥ï¸ Check Host Filesystem Certificate
          id: check-host
          if: inputs.check-host-path == 'true'
          shell: bash
          env:
              SSH_HOST: ${{ inputs.ssh-host }}
              SSH_PORT: ${{ inputs.ssh-port }}
              SSH_USER: ${{ inputs.ssh-user }}
              DOMAIN: ${{ inputs.domain }}
              HOST_CERT_PATH_TEMPLATE: ${{ inputs.host-cert-path }}
              USE_SUDO: ${{ inputs.use-sudo }}
              RENEWAL_THRESHOLD: ${{ inputs.renewal-threshold-days }}
          run: |
              HOST_CERT_PATH=$(echo "$HOST_CERT_PATH_TEMPLATE" | sed "s/{domain}/$DOMAIN/g")
              echo "ðŸ–¥ï¸  Checking host filesystem at $HOST_CERT_PATH ..."

              SUDO_CMD=""
              if [ "$USE_SUDO" = "true" ]; then
                SUDO_CMD="sudo"
              fi

              # Test SSH connectivity first
              if ! ssh -i ~/.ssh/ssl_check_key -p "$SSH_PORT" -o ConnectTimeout=10 -o BatchMode=yes "$SSH_USER@$SSH_HOST" "echo 'SSH OK'" 2>&1; then
                echo "âš ï¸ SSH connection failed â€” cannot check host filesystem"
                echo "host_exists=false"   >> $GITHUB_OUTPUT
                echo "host_type=unknown"   >> $GITHUB_OUTPUT
                echo "host_days=0"         >> $GITHUB_OUTPUT
                echo "host_expiry="        >> $GITHUB_OUTPUT
                echo "host_issuer=unknown" >> $GITHUB_OUTPUT
                exit 0
              fi

              HOST_CERT=$(ssh -i ~/.ssh/ssl_check_key \
                -p "$SSH_PORT" \
                -o StrictHostKeyChecking=no \
                -o BatchMode=yes \
                "$SSH_USER@$SSH_HOST" \
                "$SUDO_CMD openssl x509 \
                  -in $HOST_CERT_PATH \
                  -noout -subject -enddate -issuer 2>/dev/null || echo ''" 2>/dev/null) || true

              if [ -z "$HOST_CERT" ]; then
                echo "   â„¹ï¸  No certificate found on host filesystem"
                echo "host_exists=false"   >> $GITHUB_OUTPUT
                echo "host_type=none"      >> $GITHUB_OUTPUT
                echo "host_days=0"         >> $GITHUB_OUTPUT
                echo "host_expiry="        >> $GITHUB_OUTPUT
                echo "host_issuer=none"    >> $GITHUB_OUTPUT
                exit 0
              fi

              echo "host_exists=true" >> $GITHUB_OUTPUT

              # â”€â”€ Parse issuer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              HOST_ISSUER=$(echo "$HOST_CERT" | grep -i "issuer" || echo "unknown")
              echo "host_issuer=$HOST_ISSUER" >> $GITHUB_OUTPUT

              if echo "$HOST_ISSUER" | grep -qi "Let's Encrypt\|R3\|R10\|R11\|E5\|E6\|E1\|E2\|ISRG"; then
                HOST_TYPE="letsencrypt"
              else
                HOST_TYPE="self-signed"
              fi
              echo "host_type=$HOST_TYPE" >> $GITHUB_OUTPUT

              # â”€â”€ Parse expiry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              HOST_EXPIRY=$(echo "$HOST_CERT" | grep "notAfter" | cut -d= -f2)
              echo "host_expiry=$HOST_EXPIRY" >> $GITHUB_OUTPUT

              if [ -n "$HOST_EXPIRY" ]; then
                HOST_EXPIRY_EPOCH=$(ssh -i ~/.ssh/ssl_check_key \
                  -p "$SSH_PORT" \
                  -o StrictHostKeyChecking=no \
                  -o BatchMode=yes \
                  "$SSH_USER@$SSH_HOST" \
                  "$SUDO_CMD openssl x509 \
                    -in $HOST_CERT_PATH \
                    -noout -enddate 2>/dev/null \
                    | cut -d= -f2 \
                    | xargs -I{} date -d '{}' +%s 2>/dev/null || echo 0" 2>/dev/null) || true
                NOW_EPOCH=$(date +%s)
                if [ -n "$HOST_EXPIRY_EPOCH" ] && [ "$HOST_EXPIRY_EPOCH" -gt 0 ] 2>/dev/null; then
                  HOST_DAYS=$(( (HOST_EXPIRY_EPOCH - NOW_EPOCH) / 86400 ))
                else
                  HOST_DAYS=0
                fi
              else
                HOST_DAYS=0
              fi
              echo "host_days=$HOST_DAYS" >> $GITHUB_OUTPUT

              # â”€â”€ Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              echo "   Type:           $HOST_TYPE"
              echo "   Expires:        $HOST_EXPIRY"
              echo "   Days remaining: $HOST_DAYS"

              if [ "$HOST_TYPE" = "letsencrypt" ] && [ "$HOST_DAYS" -gt "$RENEWAL_THRESHOLD" ]; then
                echo "   âœ… Certificate is healthy ($HOST_DAYS days > $RENEWAL_THRESHOLD threshold)"
              elif [ "$HOST_TYPE" = "letsencrypt" ] && [ "$HOST_DAYS" -gt 0 ]; then
                echo "   âš ï¸  Certificate approaching expiry ($HOST_DAYS days â‰¤ $RENEWAL_THRESHOLD threshold)"
              elif [ "$HOST_TYPE" = "self-signed" ] && [ "$HOST_DAYS" -gt 0 ]; then
                echo "   â„¹ï¸  Self-signed cert found ($HOST_DAYS days remaining)"
              else
                echo "   âŒ Certificate is expired or invalid"
              fi

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # BEST-CERT SELECTION
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - name: ðŸ† Select Best Certificate
          id: select
          shell: bash
          env:
              RENEWAL_THRESHOLD: ${{ inputs.renewal-threshold-days }}
              # Docker volume results
              VOL_EXISTS: ${{ steps.check-volume.outputs.vol_exists }}
              VOL_TYPE: ${{ steps.check-volume.outputs.vol_type }}
              VOL_DAYS: ${{ steps.check-volume.outputs.vol_days }}
              VOL_EXPIRY: ${{ steps.check-volume.outputs.vol_expiry }}
              VOL_ISSUER: ${{ steps.check-volume.outputs.vol_issuer }}
              # Host filesystem results
              HOST_EXISTS: ${{ steps.check-host.outputs.host_exists }}
              HOST_TYPE: ${{ steps.check-host.outputs.host_type }}
              HOST_DAYS: ${{ steps.check-host.outputs.host_days }}
              HOST_EXPIRY: ${{ steps.check-host.outputs.host_expiry }}
              HOST_ISSUER: ${{ steps.check-host.outputs.host_issuer }}
          run: |
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸ† BEST-CERT SELECTION"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

              # â”€â”€ Defaults (no cert found) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              BEST_SOURCE="none"
              BEST_TYPE="none"
              BEST_DAYS=0
              BEST_EXPIRY=""
              BEST_ISSUER="none"
              NEEDS_RENEWAL="true"
              SKIP_GENERATION="false"
              CERT_EXISTS="false"

              # â”€â”€ Scoring function â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              # Priority: letsencrypt > self-signed > none
              # Within same type: more days remaining wins
              score_cert() {
                local type="$1"
                local days="$2"
                local score=0

                case "$type" in
                  letsencrypt)  score=$((200000 + days)) ;;
                  self-signed)  score=$((100000 + days)) ;;
                  *)            score=0 ;;
                esac

                # Expired certs get zero score regardless of type
                if [ "${days:-0}" -le 0 ] 2>/dev/null; then
                  score=0
                fi

                echo "$score"
              }

              VOL_SCORE=0
              HOST_SCORE=0

              # â”€â”€ Score Docker volume cert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              if [ "$VOL_EXISTS" = "true" ]; then
                VOL_SCORE=$(score_cert "$VOL_TYPE" "${VOL_DAYS:-0}")
                echo "ðŸ“¦ Docker volume:    type=$VOL_TYPE  days=${VOL_DAYS:-0}  score=$VOL_SCORE"
              else
                echo "ðŸ“¦ Docker volume:    (no certificate)"
              fi

              # â”€â”€ Score host filesystem cert â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              if [ "$HOST_EXISTS" = "true" ]; then
                HOST_SCORE=$(score_cert "$HOST_TYPE" "${HOST_DAYS:-0}")
                echo "ðŸ–¥ï¸  Host filesystem:  type=$HOST_TYPE  days=${HOST_DAYS:-0}  score=$HOST_SCORE"
              else
                echo "ðŸ–¥ï¸  Host filesystem:  (no certificate)"
              fi

              # â”€â”€ Pick winner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              if [ "$VOL_SCORE" -gt 0 ] || [ "$HOST_SCORE" -gt 0 ]; then
                CERT_EXISTS="true"

                if [ "$VOL_SCORE" -ge "$HOST_SCORE" ] && [ "$VOL_SCORE" -gt 0 ]; then
                  BEST_SOURCE="docker-volume"
                  BEST_TYPE="$VOL_TYPE"
                  BEST_DAYS="${VOL_DAYS:-0}"
                  BEST_EXPIRY="$VOL_EXPIRY"
                  BEST_ISSUER="$VOL_ISSUER"
                elif [ "$HOST_SCORE" -gt 0 ]; then
                  BEST_SOURCE="host-filesystem"
                  BEST_TYPE="$HOST_TYPE"
                  BEST_DAYS="${HOST_DAYS:-0}"
                  BEST_EXPIRY="$HOST_EXPIRY"
                  BEST_ISSUER="$HOST_ISSUER"
                fi
              fi

              # â”€â”€ Determine renewal / skip flags â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              if [ "$BEST_TYPE" = "letsencrypt" ] && [ "$BEST_DAYS" -gt "$RENEWAL_THRESHOLD" ]; then
                NEEDS_RENEWAL="false"
                SKIP_GENERATION="true"
              elif [ "$BEST_TYPE" = "letsencrypt" ] && [ "$BEST_DAYS" -gt 0 ]; then
                NEEDS_RENEWAL="true"
                SKIP_GENERATION="false"
              else
                NEEDS_RENEWAL="true"
                SKIP_GENERATION="false"
              fi

              # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              echo ""
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
              echo "ðŸ“‹ SSL DECISION"
              echo "   Best cert source: $BEST_SOURCE"
              echo "   Cert type:        $BEST_TYPE"
              echo "   Days remaining:   $BEST_DAYS"
              echo "   Needs renewal:    $NEEDS_RENEWAL"
              echo "   Skip generation:  $SKIP_GENERATION"
              echo "   Threshold:        $RENEWAL_THRESHOLD days"
              echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

              # â”€â”€ Outputs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              {
                echo "cert_exists=$CERT_EXISTS"
                echo "cert_type=$BEST_TYPE"
                echo "days_remaining=$BEST_DAYS"
                echo "expiry_date=$BEST_EXPIRY"
                echo "needs_renewal=$NEEDS_RENEWAL"
                echo "skip_generation=$SKIP_GENERATION"
                echo "issuer=$BEST_ISSUER"
                echo "cert_source=$BEST_SOURCE"
              } >> $GITHUB_OUTPUT

              # â”€â”€ Human-readable verdict â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              if [ "$BEST_TYPE" = "letsencrypt" ] && [ "$SKIP_GENERATION" = "true" ]; then
                echo ""
                echo "âœ… Valid Let's Encrypt certificate found ($BEST_DAYS days remaining, source: $BEST_SOURCE)"
                echo "â­ï¸  SSL generation can be skipped to avoid rate limits"
              elif [ "$BEST_TYPE" = "letsencrypt" ]; then
                echo ""
                echo "ðŸ”„ Let's Encrypt certificate needs renewal ($BEST_DAYS days remaining, source: $BEST_SOURCE)"
              elif [ "$BEST_TYPE" = "self-signed" ]; then
                echo ""
                echo "âš ï¸  Self-signed certificate found ($BEST_DAYS days remaining, source: $BEST_SOURCE)"
                echo "   Consider upgrading to Let's Encrypt"
              else
                echo ""
                echo "ðŸ“œ No valid certificate found â€” generation needed"
              fi

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # SUMMARY
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - name: ðŸ“Š SSL Check Summary
          if: always()
          shell: bash
          env:
              DOMAIN: ${{ inputs.domain }}
              CERT_EXISTS: ${{ steps.select.outputs.cert_exists }}
              CERT_TYPE: ${{ steps.select.outputs.cert_type }}
              DAYS_REMAINING: ${{ steps.select.outputs.days_remaining }}
              NEEDS_RENEWAL: ${{ steps.select.outputs.needs_renewal }}
              SKIP_GENERATION: ${{ steps.select.outputs.skip_generation }}
              CERT_SOURCE: ${{ steps.select.outputs.cert_source }}
              # Per-location results for the detail table
              VOL_EXISTS: ${{ steps.check-volume.outputs.vol_exists }}
              VOL_TYPE: ${{ steps.check-volume.outputs.vol_type }}
              VOL_DAYS: ${{ steps.check-volume.outputs.vol_days }}
              HOST_EXISTS: ${{ steps.check-host.outputs.host_exists }}
              HOST_TYPE: ${{ steps.check-host.outputs.host_type }}
              HOST_DAYS: ${{ steps.check-host.outputs.host_days }}
          run: |
              cat >> $GITHUB_STEP_SUMMARY << EOF
              ## ðŸ” SSL Certificate Check

              | Property | Value |
              |----------|-------|
              | Domain | \`$DOMAIN\` |
              | Exists | $CERT_EXISTS |
              | Type | $CERT_TYPE |
              | Days Remaining | $DAYS_REMAINING |
              | Needs Renewal | $NEEDS_RENEWAL |
              | Skip Generation | $SKIP_GENERATION |
              | Best Source | $CERT_SOURCE |

              ### Locations Checked
              | Location | Found | Type | Days |
              |----------|-------|------|------|
              | Docker Volume | ${VOL_EXISTS:-n/a} | ${VOL_TYPE:-n/a} | ${VOL_DAYS:-n/a} |
              | Host Filesystem | ${HOST_EXISTS:-n/a} | ${HOST_TYPE:-n/a} | ${HOST_DAYS:-n/a} |
              EOF

              if [ "$CERT_TYPE" = "letsencrypt" ] && [ "$SKIP_GENERATION" = "true" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "âœ… **Valid Let's Encrypt certificate** â€” no renewal needed" >> $GITHUB_STEP_SUMMARY
              elif [ "$CERT_TYPE" = "self-signed" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "âš ï¸ **Self-signed certificate** â€” consider upgrading to Let's Encrypt" >> $GITHUB_STEP_SUMMARY
              elif [ "$CERT_TYPE" = "none" ] || [ "$CERT_TYPE" = "unknown" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "ðŸ“œ **No certificate found** â€” generation required" >> $GITHUB_STEP_SUMMARY
              fi

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # CLEANUP
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - name: ðŸ§¹ Cleanup
          if: always()
          shell: bash
          run: |
              rm -f ~/.ssh/ssl_check_key 2>/dev/null || true
