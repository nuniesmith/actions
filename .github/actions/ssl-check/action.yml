name: "SSL Certificate Check"
description: "Check existing SSL certificates on a remote server ‚Äî supports Docker volumes, host filesystem, and best-cert selection across multiple locations"
author: "nuniesmith"

branding:
    icon: "shield"
    color: "green"

inputs:
    ssh-host:
        description: "SSH host to check certificates on"
        required: true
    ssh-port:
        description: "SSH port"
        required: false
        default: "22"
    ssh-user:
        description: "SSH username"
        required: false
        default: "actions"
    ssh-key:
        description: "SSH private key for regular user"
        required: true
    domain:
        description: "Domain name to check certificate for"
        required: true
    docker-volume-name:
        description: "Docker volume name to check for certificates (e.g., fks_ssl_certs). If empty, Docker volume check is skipped."
        required: false
        default: ""
    docker-volume-cert-path:
        description: "Path to certificate INSIDE the Docker volume container mount. Supports {domain} placeholder."
        required: false
        default: "live/{domain}/fullchain.pem"
    host-cert-path:
        description: "Path to certificate on the host filesystem. Supports {domain} placeholder."
        required: false
        default: "/etc/letsencrypt/live/{domain}/fullchain.pem"
    check-host-path:
        description: "Whether to also check the host filesystem path"
        required: false
        default: "true"
    use-sudo:
        description: "Whether to use sudo when reading host filesystem certificates"
        required: false
        default: "true"
    renewal-threshold-days:
        description: "Days before expiry to consider renewal needed (LE certs are 90 days; 27 = 70/30 overlap rule). Ignored if renewal-threshold-percent > 0."
        required: false
        default: "27"
    renewal-threshold-percent:
        description: "Percentage of certificate lifetime elapsed before renewal (e.g., 70 = renew after 70% of lifetime). Takes priority over renewal-threshold-days when > 0."
        required: false
        default: "70"

outputs:
    cert-exists:
        description: "Whether any valid SSL certificate exists"
        value: ${{ steps.select.outputs.cert_exists }}
    cert-type:
        description: "Type of certificate (letsencrypt, self-signed, none)"
        value: ${{ steps.select.outputs.cert_type }}
    days-remaining:
        description: "Days until certificate expires"
        value: ${{ steps.select.outputs.days_remaining }}
    total-days:
        description: "Total certificate lifetime in days"
        value: ${{ steps.select.outputs.total_days }}
    pct-used:
        description: "Percentage of certificate lifetime elapsed"
        value: ${{ steps.select.outputs.pct_used }}
    expiry-date:
        description: "Certificate expiry date"
        value: ${{ steps.select.outputs.expiry_date }}
    needs-renewal:
        description: "Whether the certificate needs renewal"
        value: ${{ steps.select.outputs.needs_renewal }}
    skip-generation:
        description: "Whether SSL generation can be skipped (valid cert exists)"
        value: ${{ steps.select.outputs.skip_generation }}
    issuer:
        description: "Certificate issuer"
        value: ${{ steps.select.outputs.issuer }}
    cert-source:
        description: "Source of the best certificate (docker-volume, host-filesystem, none)"
        value: ${{ steps.select.outputs.cert_source }}

runs:
    using: "composite"
    steps:
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # SSH SETUP
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        - name: üîê Setup SSH
          id: ssh-setup
          shell: bash
          env:
              SSH_KEY: ${{ inputs.ssh-key }}
              SSH_HOST: ${{ inputs.ssh-host }}
              SSH_PORT: ${{ inputs.ssh-port }}
          run: |
              mkdir -p ~/.ssh
              chmod 700 ~/.ssh
              echo "$SSH_KEY" > ~/.ssh/ssl_check_key
              chmod 600 ~/.ssh/ssl_check_key

              ssh-keyscan -p "$SSH_PORT" "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

              echo "ssh_ready=true" >> $GITHUB_OUTPUT

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # CHECK DOCKER VOLUME
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        - name: üì¶ Check Docker Volume Certificate
          id: check-volume
          if: inputs.docker-volume-name != ''
          shell: bash
          env:
              SSH_HOST: ${{ inputs.ssh-host }}
              SSH_PORT: ${{ inputs.ssh-port }}
              SSH_USER: ${{ inputs.ssh-user }}
              DOMAIN: ${{ inputs.domain }}
              VOLUME_NAME: ${{ inputs.docker-volume-name }}
              VOLUME_CERT_PATH_TEMPLATE: ${{ inputs.docker-volume-cert-path }}
              RENEWAL_THRESHOLD: ${{ inputs.renewal-threshold-days }}
          run: |
              VOLUME_CERT_PATH=$(echo "$VOLUME_CERT_PATH_TEMPLATE" | sed "s/{domain}/$DOMAIN/g")
              echo "üì¶ Checking Docker volume ($VOLUME_NAME) at /certs/$VOLUME_CERT_PATH ..."

              # Test SSH connectivity first
              if ! ssh -i ~/.ssh/ssl_check_key -p "$SSH_PORT" -o ConnectTimeout=10 -o BatchMode=yes "$SSH_USER@$SSH_HOST" "echo 'SSH OK'" 2>&1; then
                echo "‚ö†Ô∏è SSH connection failed ‚Äî cannot check Docker volume"
                echo "vol_exists=false"   >> $GITHUB_OUTPUT
                echo "vol_type=unknown"   >> $GITHUB_OUTPUT
                echo "vol_days=0"         >> $GITHUB_OUTPUT
                echo "vol_total_days=0"   >> $GITHUB_OUTPUT
                echo "vol_pct_used=100"   >> $GITHUB_OUTPUT
                echo "vol_expiry="        >> $GITHUB_OUTPUT
                echo "vol_issuer=unknown" >> $GITHUB_OUTPUT
                exit 0
              fi

              # ‚îÄ‚îÄ Single SSH call to get ALL cert metadata ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              # This avoids the latency and fragility of multiple SSH calls.
              # The remote script outputs a structured KEY:VALUE format.
              CERT_INFO=$(ssh -i ~/.ssh/ssl_check_key \
                -p "$SSH_PORT" \
                -o StrictHostKeyChecking=no \
                -o BatchMode=yes \
                "$SSH_USER@$SSH_HOST" \
                "docker run --rm -v ${VOLUME_NAME}:/certs:ro alpine/openssl:3.3.2 sh -c '
                  CERT=/certs/${VOLUME_CERT_PATH}
                  if [ ! -f \"\$CERT\" ]; then
                    echo \"EXISTS:false\"
                    exit 0
                  fi
                  echo \"EXISTS:true\"

                  # Get issuer
                  ISSUER=\$(openssl x509 -issuer -noout -in \$CERT 2>/dev/null || echo \"unknown\")
                  echo \"ISSUER:\$ISSUER\"

                  # Get dates
                  END_DATE=\$(openssl x509 -enddate -noout -in \$CERT 2>/dev/null | cut -d= -f2)
                  START_DATE=\$(openssl x509 -startdate -noout -in \$CERT 2>/dev/null | cut -d= -f2)
                  echo \"END_DATE:\$END_DATE\"

                  # Calculate epochs and derived values
                  END_EPOCH=\$(date -d \"\$END_DATE\" +%s 2>/dev/null || echo 0)
                  START_EPOCH=\$(date -d \"\$START_DATE\" +%s 2>/dev/null || echo 0)
                  NOW_EPOCH=\$(date +%s)

                  REMAINING=\$((END_EPOCH - NOW_EPOCH))
                  TOTAL=\$((END_EPOCH - START_EPOCH))
                  DAYS_REMAINING=\$((REMAINING / 86400))
                  TOTAL_DAYS=\$((TOTAL / 86400))

                  if [ \$TOTAL -gt 0 ]; then
                    PCT_USED=\$(( (NOW_EPOCH - START_EPOCH) * 100 / TOTAL ))
                  else
                    PCT_USED=100
                  fi

                  echo \"DAYS:\$DAYS_REMAINING\"
                  echo \"TOTAL_DAYS:\$TOTAL_DAYS\"
                  echo \"PCT_USED:\$PCT_USED\"
                '" 2>/dev/null) || true

              # ‚îÄ‚îÄ Parse structured output ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              if [ -z "$CERT_INFO" ]; then
                VOL_EXISTS="false"
              else
                VOL_EXISTS=$(echo "$CERT_INFO" | grep -o 'EXISTS:[^ ]*' | cut -d: -f2 || echo "false")
              fi

              if [ "$VOL_EXISTS" != "true" ]; then
                echo "   ‚ùå No certificate found in Docker volume"
                echo "vol_exists=false"   >> $GITHUB_OUTPUT
                echo "vol_type=none"      >> $GITHUB_OUTPUT
                echo "vol_days=0"         >> $GITHUB_OUTPUT
                echo "vol_total_days=0"   >> $GITHUB_OUTPUT
                echo "vol_pct_used=100"   >> $GITHUB_OUTPUT
                echo "vol_expiry="        >> $GITHUB_OUTPUT
                echo "vol_issuer=none"    >> $GITHUB_OUTPUT
                exit 0
              fi

              echo "vol_exists=true" >> $GITHUB_OUTPUT

              VOL_ISSUER=$(echo "$CERT_INFO" | grep 'ISSUER:' | cut -d: -f2- || echo "unknown")
              VOL_EXPIRY=$(echo "$CERT_INFO" | grep 'END_DATE:' | cut -d: -f2- || echo "")
              VOL_DAYS=$(echo "$CERT_INFO" | grep '^DAYS:' | cut -d: -f2 || echo "0")
              VOL_TOTAL_DAYS=$(echo "$CERT_INFO" | grep '^TOTAL_DAYS:' | cut -d: -f2 || echo "0")
              VOL_PCT_USED=$(echo "$CERT_INFO" | grep '^PCT_USED:' | cut -d: -f2 || echo "100")

              echo "vol_issuer=$VOL_ISSUER" >> $GITHUB_OUTPUT
              echo "vol_expiry=$VOL_EXPIRY" >> $GITHUB_OUTPUT
              echo "vol_days=${VOL_DAYS:-0}" >> $GITHUB_OUTPUT
              echo "vol_total_days=${VOL_TOTAL_DAYS:-0}" >> $GITHUB_OUTPUT
              echo "vol_pct_used=${VOL_PCT_USED:-100}" >> $GITHUB_OUTPUT

              if echo "$VOL_ISSUER" | grep -qi "Let's Encrypt\|R3\|R10\|R11\|E5\|E6\|E1\|E2\|ISRG"; then
                VOL_TYPE="letsencrypt"
              else
                VOL_TYPE="self-signed"
              fi
              echo "vol_type=$VOL_TYPE" >> $GITHUB_OUTPUT

              # ‚îÄ‚îÄ Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              echo "   Type:            $VOL_TYPE"
              echo "   Expires:         $VOL_EXPIRY"
              echo "   Days remaining:  ${VOL_DAYS:-0}"
              echo "   Total lifetime:  ${VOL_TOTAL_DAYS:-0} days"
              echo "   Lifetime used:   ${VOL_PCT_USED:-?}%"

              if [ "$VOL_TYPE" = "letsencrypt" ] && [ "${VOL_DAYS:-0}" -gt "$RENEWAL_THRESHOLD" ]; then
                echo "   ‚úÖ Certificate is healthy (${VOL_DAYS} days > $RENEWAL_THRESHOLD threshold)"
              elif [ "$VOL_TYPE" = "letsencrypt" ] && [ "${VOL_DAYS:-0}" -gt 0 ]; then
                echo "   ‚ö†Ô∏è  Certificate approaching expiry (${VOL_DAYS} days ‚â§ $RENEWAL_THRESHOLD threshold)"
              elif [ "$VOL_TYPE" = "self-signed" ] && [ "${VOL_DAYS:-0}" -gt 0 ]; then
                echo "   ‚ÑπÔ∏è  Self-signed cert found (${VOL_DAYS} days remaining)"
              else
                echo "   ‚ùå Certificate is expired or invalid"
              fi

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # CHECK HOST FILESYSTEM
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        - name: üñ•Ô∏è Check Host Filesystem Certificate
          id: check-host
          if: inputs.check-host-path == 'true'
          shell: bash
          env:
              SSH_HOST: ${{ inputs.ssh-host }}
              SSH_PORT: ${{ inputs.ssh-port }}
              SSH_USER: ${{ inputs.ssh-user }}
              DOMAIN: ${{ inputs.domain }}
              HOST_CERT_PATH_TEMPLATE: ${{ inputs.host-cert-path }}
              USE_SUDO: ${{ inputs.use-sudo }}
              RENEWAL_THRESHOLD: ${{ inputs.renewal-threshold-days }}
          run: |
              HOST_CERT_PATH=$(echo "$HOST_CERT_PATH_TEMPLATE" | sed "s/{domain}/$DOMAIN/g")
              echo "üñ•Ô∏è  Checking host filesystem at $HOST_CERT_PATH ..."

              SUDO_CMD=""
              if [ "$USE_SUDO" = "true" ]; then
                SUDO_CMD="sudo"
              fi

              # Test SSH connectivity first
              if ! ssh -i ~/.ssh/ssl_check_key -p "$SSH_PORT" -o ConnectTimeout=10 -o BatchMode=yes "$SSH_USER@$SSH_HOST" "echo 'SSH OK'" 2>&1; then
                echo "‚ö†Ô∏è SSH connection failed ‚Äî cannot check host filesystem"
                echo "host_exists=false"   >> $GITHUB_OUTPUT
                echo "host_type=unknown"   >> $GITHUB_OUTPUT
                echo "host_days=0"         >> $GITHUB_OUTPUT
                echo "host_total_days=0"   >> $GITHUB_OUTPUT
                echo "host_pct_used=100"   >> $GITHUB_OUTPUT
                echo "host_expiry="        >> $GITHUB_OUTPUT
                echo "host_issuer=unknown" >> $GITHUB_OUTPUT
                exit 0
              fi

              # ‚îÄ‚îÄ Single SSH call to get ALL cert metadata ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              CERT_INFO=$(ssh -i ~/.ssh/ssl_check_key \
                -p "$SSH_PORT" \
                -o StrictHostKeyChecking=no \
                -o BatchMode=yes \
                "$SSH_USER@$SSH_HOST" \
                "$SUDO_CMD sh -c '
                  CERT=\"$HOST_CERT_PATH\"
                  if [ ! -f \"\$CERT\" ]; then
                    echo \"EXISTS:false\"
                    exit 0
                  fi
                  echo \"EXISTS:true\"

                  ISSUER=\$(openssl x509 -issuer -noout -in \$CERT 2>/dev/null || echo \"unknown\")
                  echo \"ISSUER:\$ISSUER\"

                  END_DATE=\$(openssl x509 -enddate -noout -in \$CERT 2>/dev/null | cut -d= -f2)
                  START_DATE=\$(openssl x509 -startdate -noout -in \$CERT 2>/dev/null | cut -d= -f2)
                  echo \"END_DATE:\$END_DATE\"

                  END_EPOCH=\$(date -d \"\$END_DATE\" +%s 2>/dev/null || echo 0)
                  START_EPOCH=\$(date -d \"\$START_DATE\" +%s 2>/dev/null || echo 0)
                  NOW_EPOCH=\$(date +%s)

                  REMAINING=\$((END_EPOCH - NOW_EPOCH))
                  TOTAL=\$((END_EPOCH - START_EPOCH))
                  DAYS_REMAINING=\$((REMAINING / 86400))
                  TOTAL_DAYS=\$((TOTAL / 86400))

                  if [ \$TOTAL -gt 0 ]; then
                    PCT_USED=\$(( (NOW_EPOCH - START_EPOCH) * 100 / TOTAL ))
                  else
                    PCT_USED=100
                  fi

                  echo \"DAYS:\$DAYS_REMAINING\"
                  echo \"TOTAL_DAYS:\$TOTAL_DAYS\"
                  echo \"PCT_USED:\$PCT_USED\"
                '" 2>/dev/null) || true

              # ‚îÄ‚îÄ Parse structured output ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              if [ -z "$CERT_INFO" ]; then
                HOST_EXISTS="false"
              else
                HOST_EXISTS=$(echo "$CERT_INFO" | grep -o 'EXISTS:[^ ]*' | cut -d: -f2 || echo "false")
              fi

              if [ "$HOST_EXISTS" != "true" ]; then
                echo "   ‚ÑπÔ∏è  No certificate found on host filesystem"
                echo "host_exists=false"   >> $GITHUB_OUTPUT
                echo "host_type=none"      >> $GITHUB_OUTPUT
                echo "host_days=0"         >> $GITHUB_OUTPUT
                echo "host_total_days=0"   >> $GITHUB_OUTPUT
                echo "host_pct_used=100"   >> $GITHUB_OUTPUT
                echo "host_expiry="        >> $GITHUB_OUTPUT
                echo "host_issuer=none"    >> $GITHUB_OUTPUT
                exit 0
              fi

              echo "host_exists=true" >> $GITHUB_OUTPUT

              HOST_ISSUER=$(echo "$CERT_INFO" | grep 'ISSUER:' | cut -d: -f2- || echo "unknown")
              HOST_EXPIRY=$(echo "$CERT_INFO" | grep 'END_DATE:' | cut -d: -f2- || echo "")
              HOST_DAYS=$(echo "$CERT_INFO" | grep '^DAYS:' | cut -d: -f2 || echo "0")
              HOST_TOTAL_DAYS=$(echo "$CERT_INFO" | grep '^TOTAL_DAYS:' | cut -d: -f2 || echo "0")
              HOST_PCT_USED=$(echo "$CERT_INFO" | grep '^PCT_USED:' | cut -d: -f2 || echo "100")

              echo "host_issuer=$HOST_ISSUER" >> $GITHUB_OUTPUT
              echo "host_expiry=$HOST_EXPIRY" >> $GITHUB_OUTPUT
              echo "host_days=${HOST_DAYS:-0}" >> $GITHUB_OUTPUT
              echo "host_total_days=${HOST_TOTAL_DAYS:-0}" >> $GITHUB_OUTPUT
              echo "host_pct_used=${HOST_PCT_USED:-100}" >> $GITHUB_OUTPUT

              if echo "$HOST_ISSUER" | grep -qi "Let's Encrypt\|R3\|R10\|R11\|E5\|E6\|E1\|E2\|ISRG"; then
                HOST_TYPE="letsencrypt"
              else
                HOST_TYPE="self-signed"
              fi
              echo "host_type=$HOST_TYPE" >> $GITHUB_OUTPUT

              # ‚îÄ‚îÄ Log ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              echo "   Type:            $HOST_TYPE"
              echo "   Expires:         $HOST_EXPIRY"
              echo "   Days remaining:  ${HOST_DAYS:-0}"
              echo "   Total lifetime:  ${HOST_TOTAL_DAYS:-0} days"
              echo "   Lifetime used:   ${HOST_PCT_USED:-?}%"

              if [ "$HOST_TYPE" = "letsencrypt" ] && [ "${HOST_DAYS:-0}" -gt "$RENEWAL_THRESHOLD" ]; then
                echo "   ‚úÖ Certificate is healthy (${HOST_DAYS} days > $RENEWAL_THRESHOLD threshold)"
              elif [ "$HOST_TYPE" = "letsencrypt" ] && [ "${HOST_DAYS:-0}" -gt 0 ]; then
                echo "   ‚ö†Ô∏è  Certificate approaching expiry (${HOST_DAYS} days ‚â§ $RENEWAL_THRESHOLD threshold)"
              elif [ "$HOST_TYPE" = "self-signed" ] && [ "${HOST_DAYS:-0}" -gt 0 ]; then
                echo "   ‚ÑπÔ∏è  Self-signed cert found (${HOST_DAYS} days remaining)"
              else
                echo "   ‚ùå Certificate is expired or invalid"
              fi

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # BEST-CERT SELECTION
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        - name: üèÜ Select Best Certificate
          id: select
          shell: bash
          env:
              RENEWAL_THRESHOLD: ${{ inputs.renewal-threshold-days }}
              RENEWAL_THRESHOLD_PCT: ${{ inputs.renewal-threshold-percent }}
              # Docker volume results
              VOL_EXISTS: ${{ steps.check-volume.outputs.vol_exists }}
              VOL_TYPE: ${{ steps.check-volume.outputs.vol_type }}
              VOL_DAYS: ${{ steps.check-volume.outputs.vol_days }}
              VOL_TOTAL_DAYS: ${{ steps.check-volume.outputs.vol_total_days }}
              VOL_PCT_USED: ${{ steps.check-volume.outputs.vol_pct_used }}
              VOL_EXPIRY: ${{ steps.check-volume.outputs.vol_expiry }}
              VOL_ISSUER: ${{ steps.check-volume.outputs.vol_issuer }}
              # Host filesystem results
              HOST_EXISTS: ${{ steps.check-host.outputs.host_exists }}
              HOST_TYPE: ${{ steps.check-host.outputs.host_type }}
              HOST_DAYS: ${{ steps.check-host.outputs.host_days }}
              HOST_TOTAL_DAYS: ${{ steps.check-host.outputs.host_total_days }}
              HOST_PCT_USED: ${{ steps.check-host.outputs.host_pct_used }}
              HOST_EXPIRY: ${{ steps.check-host.outputs.host_expiry }}
              HOST_ISSUER: ${{ steps.check-host.outputs.host_issuer }}
          run: |
              echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
              echo "üèÜ BEST-CERT SELECTION"
              echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

              # ‚îÄ‚îÄ Defaults (no cert found) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              BEST_SOURCE="none"
              BEST_TYPE="none"
              BEST_DAYS=0
              BEST_TOTAL_DAYS=0
              BEST_PCT_USED=100
              BEST_EXPIRY=""
              BEST_ISSUER="none"
              NEEDS_RENEWAL="true"
              SKIP_GENERATION="false"
              CERT_EXISTS="false"

              # ‚îÄ‚îÄ Scoring function ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              # Priority: letsencrypt > self-signed > none
              # Within same type: more days remaining wins
              score_cert() {
                local type="$1"
                local days="$2"
                local score=0

                case "$type" in
                  letsencrypt)  score=$((200000 + days)) ;;
                  self-signed)  score=$((100000 + days)) ;;
                  *)            score=0 ;;
                esac

                # Expired certs get zero score regardless of type
                if [ "${days:-0}" -le 0 ] 2>/dev/null; then
                  score=0
                fi

                echo "$score"
              }

              VOL_SCORE=0
              HOST_SCORE=0

              # ‚îÄ‚îÄ Score Docker volume cert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              if [ "$VOL_EXISTS" = "true" ]; then
                VOL_SCORE=$(score_cert "$VOL_TYPE" "${VOL_DAYS:-0}")
                echo "üì¶ Docker volume:    type=$VOL_TYPE  days=${VOL_DAYS:-0}/${VOL_TOTAL_DAYS:-?}  ${VOL_PCT_USED:-?}% used  score=$VOL_SCORE"
              else
                echo "üì¶ Docker volume:    (no certificate)"
              fi

              # ‚îÄ‚îÄ Score host filesystem cert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              if [ "$HOST_EXISTS" = "true" ]; then
                HOST_SCORE=$(score_cert "$HOST_TYPE" "${HOST_DAYS:-0}")
                echo "üñ•Ô∏è  Host filesystem:  type=$HOST_TYPE  days=${HOST_DAYS:-0}/${HOST_TOTAL_DAYS:-?}  ${HOST_PCT_USED:-?}% used  score=$HOST_SCORE"
              else
                echo "üñ•Ô∏è  Host filesystem:  (no certificate)"
              fi

              # ‚îÄ‚îÄ Pick winner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              if [ "$VOL_SCORE" -gt 0 ] || [ "$HOST_SCORE" -gt 0 ]; then
                CERT_EXISTS="true"

                if [ "$VOL_SCORE" -ge "$HOST_SCORE" ] && [ "$VOL_SCORE" -gt 0 ]; then
                  BEST_SOURCE="docker-volume"
                  BEST_TYPE="$VOL_TYPE"
                  BEST_DAYS="${VOL_DAYS:-0}"
                  BEST_TOTAL_DAYS="${VOL_TOTAL_DAYS:-0}"
                  BEST_PCT_USED="${VOL_PCT_USED:-100}"
                  BEST_EXPIRY="$VOL_EXPIRY"
                  BEST_ISSUER="$VOL_ISSUER"
                elif [ "$HOST_SCORE" -gt 0 ]; then
                  BEST_SOURCE="host-filesystem"
                  BEST_TYPE="$HOST_TYPE"
                  BEST_DAYS="${HOST_DAYS:-0}"
                  BEST_TOTAL_DAYS="${HOST_TOTAL_DAYS:-0}"
                  BEST_PCT_USED="${HOST_PCT_USED:-100}"
                  BEST_EXPIRY="$HOST_EXPIRY"
                  BEST_ISSUER="$HOST_ISSUER"
                fi
              fi

              # ‚îÄ‚îÄ Determine renewal / skip flags ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              # Support both percentage-based and days-based thresholds.
              # If renewal-threshold-percent > 0, use percentage of lifetime.
              # Otherwise fall back to fixed days threshold.
              if [ "$BEST_TYPE" = "letsencrypt" ] || [ "$BEST_TYPE" = "self-signed" ]; then
                if [ "${RENEWAL_THRESHOLD_PCT:-0}" -gt 0 ] 2>/dev/null; then
                  # ‚îÄ‚îÄ Percentage-based threshold ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                  # Renew when PCT_USED >= threshold (e.g., 70% of lifetime elapsed)
                  echo ""
                  echo "üìä Using percentage-based threshold: renew when ‚â•${RENEWAL_THRESHOLD_PCT}% of lifetime elapsed"
                  echo "   Current: ${BEST_PCT_USED}% elapsed (${BEST_DAYS} of ${BEST_TOTAL_DAYS} days remaining)"

                  if [ "${BEST_DAYS:-0}" -le 0 ] 2>/dev/null; then
                    echo "   ‚ùå Certificate is expired"
                    NEEDS_RENEWAL="true"
                    SKIP_GENERATION="false"
                  elif [ "${BEST_PCT_USED:-100}" -ge "${RENEWAL_THRESHOLD_PCT}" ] 2>/dev/null; then
                    echo "   ‚ö†Ô∏è  ${BEST_PCT_USED}% ‚â• ${RENEWAL_THRESHOLD_PCT}% ‚Üí should renew"
                    NEEDS_RENEWAL="true"
                    SKIP_GENERATION="false"
                  else
                    echo "   ‚úÖ ${BEST_PCT_USED}% < ${RENEWAL_THRESHOLD_PCT}% ‚Üí skip generation"
                    NEEDS_RENEWAL="false"
                    SKIP_GENERATION="true"
                  fi
                else
                  # ‚îÄ‚îÄ Days-based threshold (legacy) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                  echo ""
                  echo "üìä Using days-based threshold: renew when ‚â§${RENEWAL_THRESHOLD} days remaining"

                  if [ "$BEST_DAYS" -gt "$RENEWAL_THRESHOLD" ]; then
                    NEEDS_RENEWAL="false"
                    SKIP_GENERATION="true"
                  elif [ "$BEST_DAYS" -gt 0 ]; then
                    NEEDS_RENEWAL="true"
                    SKIP_GENERATION="false"
                  else
                    NEEDS_RENEWAL="true"
                    SKIP_GENERATION="false"
                  fi
                fi
              fi

              # ‚îÄ‚îÄ Summary ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              echo ""
              echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
              echo "üìã SSL DECISION"
              echo "   Best cert source: $BEST_SOURCE"
              echo "   Cert type:        $BEST_TYPE"
              echo "   Days remaining:   $BEST_DAYS / $BEST_TOTAL_DAYS total"
              echo "   Lifetime used:    ${BEST_PCT_USED}%"
              echo "   Needs renewal:    $NEEDS_RENEWAL"
              echo "   Skip generation:  $SKIP_GENERATION"
              echo "   Threshold (pct):  ${RENEWAL_THRESHOLD_PCT}%"
              echo "   Threshold (days): $RENEWAL_THRESHOLD"
              echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

              # ‚îÄ‚îÄ Outputs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              {
                echo "cert_exists=$CERT_EXISTS"
                echo "cert_type=$BEST_TYPE"
                echo "days_remaining=$BEST_DAYS"
                echo "total_days=$BEST_TOTAL_DAYS"
                echo "pct_used=$BEST_PCT_USED"
                echo "expiry_date=$BEST_EXPIRY"
                echo "needs_renewal=$NEEDS_RENEWAL"
                echo "skip_generation=$SKIP_GENERATION"
                echo "issuer=$BEST_ISSUER"
                echo "cert_source=$BEST_SOURCE"
              } >> $GITHUB_OUTPUT

              # ‚îÄ‚îÄ Human-readable verdict ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
              if [ "$SKIP_GENERATION" = "true" ]; then
                echo ""
                echo "‚úÖ Valid ${BEST_TYPE} certificate found (${BEST_DAYS} days remaining, ${BEST_PCT_USED}% used, source: $BEST_SOURCE)"
                echo "‚è≠Ô∏è  SSL generation can be skipped"
              elif [ "$BEST_TYPE" = "letsencrypt" ]; then
                echo ""
                echo "üîÑ Let's Encrypt certificate needs renewal (${BEST_DAYS} days remaining, ${BEST_PCT_USED}% used, source: $BEST_SOURCE)"
              elif [ "$BEST_TYPE" = "self-signed" ]; then
                echo ""
                echo "‚ö†Ô∏è  Self-signed certificate found (${BEST_DAYS} days remaining, source: $BEST_SOURCE)"
                echo "   Consider upgrading to Let's Encrypt"
              else
                echo ""
                echo "üìú No valid certificate found ‚Äî generation needed"
              fi

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # SUMMARY
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        - name: üìä SSL Check Summary
          if: always()
          shell: bash
          env:
              DOMAIN: ${{ inputs.domain }}
              CERT_EXISTS: ${{ steps.select.outputs.cert_exists }}
              CERT_TYPE: ${{ steps.select.outputs.cert_type }}
              DAYS_REMAINING: ${{ steps.select.outputs.days_remaining }}
              NEEDS_RENEWAL: ${{ steps.select.outputs.needs_renewal }}
              SKIP_GENERATION: ${{ steps.select.outputs.skip_generation }}
              CERT_SOURCE: ${{ steps.select.outputs.cert_source }}
              # Per-location results for the detail table
              VOL_EXISTS: ${{ steps.check-volume.outputs.vol_exists }}
              VOL_TYPE: ${{ steps.check-volume.outputs.vol_type }}
              VOL_DAYS: ${{ steps.check-volume.outputs.vol_days }}
              HOST_EXISTS: ${{ steps.check-host.outputs.host_exists }}
              HOST_TYPE: ${{ steps.check-host.outputs.host_type }}
              HOST_DAYS: ${{ steps.check-host.outputs.host_days }}
          run: |
              cat >> $GITHUB_STEP_SUMMARY << EOF
              ## üîê SSL Certificate Check

              | Property | Value |
              |----------|-------|
              | Domain | \`$DOMAIN\` |
              | Exists | $CERT_EXISTS |
              | Type | $CERT_TYPE |
              | Days Remaining | $DAYS_REMAINING |
              | Needs Renewal | $NEEDS_RENEWAL |
              | Skip Generation | $SKIP_GENERATION |
              | Best Source | $CERT_SOURCE |

              ### Locations Checked
              | Location | Found | Type | Days |
              |----------|-------|------|------|
              | Docker Volume | ${VOL_EXISTS:-n/a} | ${VOL_TYPE:-n/a} | ${VOL_DAYS:-n/a} |
              | Host Filesystem | ${HOST_EXISTS:-n/a} | ${HOST_TYPE:-n/a} | ${HOST_DAYS:-n/a} |
              EOF

              if [ "$CERT_TYPE" = "letsencrypt" ] && [ "$SKIP_GENERATION" = "true" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "‚úÖ **Valid Let's Encrypt certificate** ‚Äî no renewal needed" >> $GITHUB_STEP_SUMMARY
              elif [ "$CERT_TYPE" = "self-signed" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "‚ö†Ô∏è **Self-signed certificate** ‚Äî consider upgrading to Let's Encrypt" >> $GITHUB_STEP_SUMMARY
              elif [ "$CERT_TYPE" = "none" ] || [ "$CERT_TYPE" = "unknown" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "üìú **No certificate found** ‚Äî generation required" >> $GITHUB_STEP_SUMMARY
              fi

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # CLEANUP
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        - name: üßπ Cleanup
          if: always()
          shell: bash
          run: |
              rm -f ~/.ssh/ssl_check_key 2>/dev/null || true
