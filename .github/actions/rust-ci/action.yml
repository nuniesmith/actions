name: "Rust CI"
description: "Complete Rust CI pipeline with caching, linting, testing, building, and optional protobuf support"
author: "nuniesmith"

branding:
    icon: "check-circle"
    color: "orange"

inputs:
    toolchain:
        description: "Rust toolchain (stable, beta, nightly, or specific version like 1.92.0)"
        required: false
        default: "stable"
    components:
        description: "Additional components (comma-separated: rustfmt, clippy, llvm-tools-preview)"
        required: false
        default: "rustfmt, clippy"
    targets:
        description: "Additional targets to install (comma-separated)"
        required: false
        default: ""
    run-fmt:
        description: "Run cargo fmt check"
        required: false
        default: "true"
    run-clippy:
        description: "Run cargo clippy"
        required: false
        default: "true"
    run-tests:
        description: "Run cargo test"
        required: false
        default: "true"
    run-build:
        description: "Run cargo build"
        required: false
        default: "true"
    build-release:
        description: "Build in release mode"
        required: false
        default: "true"
    clippy-args:
        description: "Additional arguments for clippy"
        required: false
        default: "--all-targets -- -D warnings"
    test-args:
        description: "Additional arguments for test"
        required: false
        default: "--verbose"
    build-args:
        description: "Additional arguments for build"
        required: false
        default: "--verbose"
    features:
        description: "Features to enable (comma-separated)"
        required: false
        default: ""
    all-features:
        description: "Enable all features"
        required: false
        default: "false"
    no-default-features:
        description: "Disable default features"
        required: false
        default: "false"
    working-directory:
        description: "Working directory for cargo commands"
        required: false
        default: "."
    coverage:
        description: "Generate code coverage with cargo-tarpaulin"
        required: false
        default: "false"
    coverage-output-dir:
        description: "Coverage output directory"
        required: false
        default: "./coverage"
    # Workspace-specific options
    workspace:
        description: "Build/test entire workspace (--workspace flag)"
        required: false
        default: "false"
    packages:
        description: "Specific packages to build/test (comma-separated, uses -p flag)"
        required: false
        default: ""
    exclude-packages:
        description: "Packages to exclude from workspace (comma-separated, uses --exclude flag)"
        required: false
        default: ""
    # Protobuf/buf options
    install-protobuf:
        description: "Install protobuf compiler"
        required: false
        default: "false"
    install-buf:
        description: "Install buf CLI for protobuf linting"
        required: false
        default: "false"
    run-buf-lint:
        description: "Run buf lint on proto files"
        required: false
        default: "false"
    run-buf-breaking:
        description: "Run buf breaking change detection (requires git history)"
        required: false
        default: "false"
    proto-directory:
        description: "Directory containing proto files"
        required: false
        default: "proto"
    buf-breaking-against:
        description: "Git reference to check breaking changes against"
        required: false
        default: ".git#branch=main"
    # Build ordering
    pre-build-packages:
        description: "Packages to build first before main build (comma-separated)"
        required: false
        default: ""
    # Test configuration
    test-lib-only:
        description: "Run only library tests (--lib flag)"
        required: false
        default: "false"
    test-bins:
        description: "Run binary tests (--bins flag)"
        required: false
        default: "false"
    test-integration:
        description: "Run integration tests separately (--test flag)"
        required: false
        default: "false"
    # System dependencies
    install-system-deps:
        description: "Install common system dependencies (libssl-dev, pkg-config, etc.)"
        required: false
        default: "false"
    additional-apt-packages:
        description: "Additional apt packages to install (space-separated)"
        required: false
        default: ""
    # Caching
    cache-key-suffix:
        description: "Suffix for cache key to differentiate between jobs"
        required: false
        default: "rust-ci"

outputs:
    fmt-result:
        description: "Result of fmt check (success/failure/skipped)"
        value: ${{ steps.fmt.outputs.result || steps.fmt-skip.outputs.result }}
    clippy-result:
        description: "Result of clippy (success/failure/skipped)"
        value: ${{ steps.clippy.outputs.result || steps.clippy-skip.outputs.result }}
    test-result:
        description: "Result of tests (success/failure/skipped)"
        value: ${{ steps.test.outputs.result || steps.test-skip.outputs.result }}
    build-result:
        description: "Result of build (success/failure/skipped)"
        value: ${{ steps.build.outputs.result || steps.build-skip.outputs.result }}
    coverage-file:
        description: "Path to coverage file (if generated)"
        value: ${{ steps.coverage.outputs.coverage_file || '' }}
    buf-lint-result:
        description: "Result of buf lint (success/failure/skipped)"
        value: ${{ steps.buf-lint.outputs.result || 'skipped' }}
    clippy-sarif-file:
        description: "Path to clippy SARIF file (if generated)"
        value: ${{ steps.clippy-sarif.outputs.sarif_file || '' }}

runs:
    using: "composite"
    steps:
        - name: ðŸ“¦ Install system dependencies
          if: inputs.install-system-deps == 'true' || inputs.additional-apt-packages != ''
          shell: bash
          run: |
              echo "ðŸ“¦ Installing system dependencies..."
              sudo apt-get update -qq

              PACKAGES=""
              if [ "${{ inputs.install-system-deps }}" = "true" ]; then
                PACKAGES="build-essential pkg-config libssl-dev"
              fi

              if [ -n "${{ inputs.additional-apt-packages }}" ]; then
                PACKAGES="$PACKAGES ${{ inputs.additional-apt-packages }}"
              fi

              if [ -n "$PACKAGES" ]; then
                sudo apt-get install -y -qq $PACKAGES
                echo "âœ… System dependencies installed"
              fi

        - name: ðŸ¦€ Install Rust toolchain
          uses: dtolnay/rust-toolchain@master
          with:
              toolchain: ${{ inputs.toolchain }}
              components: ${{ inputs.components }}
              targets: ${{ inputs.targets }}

        - name: ðŸ“¦ Install protobuf compiler
          if: inputs.install-protobuf == 'true'
          shell: bash
          run: |
              echo "ðŸ“¦ Installing protobuf compiler..."
              sudo apt-get update -qq
              sudo apt-get install -y -qq protobuf-compiler libprotobuf-dev
              protoc --version
              echo "âœ… Protobuf compiler installed"

        - name: ðŸ“¦ Install buf CLI
          if: inputs.install-buf == 'true'
          uses: bufbuild/buf-setup-action@v1
          with:
              github_token: ${{ github.token }}

        - name: ðŸ“¦ Cache cargo registry
          uses: actions/cache@v4
          with:
              path: |
                  ~/.cargo/bin/
                  ~/.cargo/registry/index/
                  ~/.cargo/registry/cache/
                  ~/.cargo/git/db/
              key: ${{ runner.os }}-cargo-registry-${{ inputs.cache-key-suffix }}-${{ hashFiles('**/Cargo.lock') }}
              restore-keys: |
                  ${{ runner.os }}-cargo-registry-${{ inputs.cache-key-suffix }}-
                  ${{ runner.os }}-cargo-registry-

        - name: ðŸ“¦ Compute feature hash
          id: feature-hash
          shell: bash
          run: |
              # Build a stable string from feature inputs to include in cache key
              FEATURE_STRING="${{ inputs.all-features }}|${{ inputs.features }}|${{ inputs.no-default-features }}"
              FEATURE_HASH=$(echo -n "$FEATURE_STRING" | sha256sum | cut -c1-8)
              echo "hash=$FEATURE_HASH" >> $GITHUB_OUTPUT

        - name: ðŸ“¦ Cache cargo build
          uses: actions/cache@v4
          with:
              path: |
                  target/
                  ${{ inputs.working-directory }}/target/
              key: ${{ runner.os }}-cargo-build-${{ inputs.cache-key-suffix }}-${{ inputs.toolchain }}-feat${{ steps.feature-hash.outputs.hash }}-${{ hashFiles('**/Cargo.lock') }}
              restore-keys: |
                  ${{ runner.os }}-cargo-build-${{ inputs.cache-key-suffix }}-${{ inputs.toolchain }}-feat${{ steps.feature-hash.outputs.hash }}-
                  ${{ runner.os }}-cargo-build-${{ inputs.cache-key-suffix }}-${{ inputs.toolchain }}-

        - name: ðŸ”§ Prepare flags
          id: flags
          shell: bash
          run: |
              # Feature flags
              FEATURE_FLAGS=""
              if [ "${{ inputs.all-features }}" = "true" ]; then
                FEATURE_FLAGS="--all-features"
              elif [ -n "${{ inputs.features }}" ]; then
                FEATURE_FLAGS="--features ${{ inputs.features }}"
              fi
              if [ "${{ inputs.no-default-features }}" = "true" ]; then
                FEATURE_FLAGS="$FEATURE_FLAGS --no-default-features"
              fi
              echo "feature_flags=$FEATURE_FLAGS" >> $GITHUB_OUTPUT

              # Workspace/package flags
              PACKAGE_FLAGS=""
              if [ "${{ inputs.workspace }}" = "true" ]; then
                PACKAGE_FLAGS="--workspace"
              fi
              if [ -n "${{ inputs.packages }}" ]; then
                IFS=',' read -ra PKGS <<< "${{ inputs.packages }}"
                for pkg in "${PKGS[@]}"; do
                  pkg=$(echo "$pkg" | xargs)
                  PACKAGE_FLAGS="$PACKAGE_FLAGS -p $pkg"
                done
              fi
              if [ -n "${{ inputs.exclude-packages }}" ]; then
                IFS=',' read -ra EXCLUDES <<< "${{ inputs.exclude-packages }}"
                for exc in "${EXCLUDES[@]}"; do
                  exc=$(echo "$exc" | xargs)
                  PACKAGE_FLAGS="$PACKAGE_FLAGS --exclude $exc"
                done
              fi
              echo "package_flags=$PACKAGE_FLAGS" >> $GITHUB_OUTPUT

              # Release flag
              RELEASE_FLAG=""
              if [ "${{ inputs.build-release }}" = "true" ]; then
                RELEASE_FLAG="--release"
              fi
              echo "release_flag=$RELEASE_FLAG" >> $GITHUB_OUTPUT

        - name: ðŸ” Buf lint
          id: buf-lint
          if: inputs.run-buf-lint == 'true'
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          run: |
              echo "ðŸ” Linting Protocol Buffers..."
              cd ${{ inputs.proto-directory }}
              if buf lint; then
                echo "âœ… Proto files pass linting"
                echo "result=success" >> $GITHUB_OUTPUT
              else
                echo "âŒ Proto lint failed"
                echo "result=failure" >> $GITHUB_OUTPUT
                exit 1
              fi

        - name: ðŸ”’ Buf breaking change check
          if: inputs.run-buf-breaking == 'true'
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          continue-on-error: true
          run: |
              echo "ðŸ”’ Checking for breaking proto changes..."
              cd ${{ inputs.proto-directory }}
              buf breaking --against '${{ inputs.buf-breaking-against }}' || echo "âš ï¸ Breaking changes detected (non-fatal)"

        - name: ðŸ“ Run cargo fmt
          id: fmt
          if: inputs.run-fmt == 'true'
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          run: |
              echo "ðŸ” Checking code formatting..."
              if cargo fmt --all -- --check; then
                echo "âœ… Code formatting check passed"
                echo "result=success" >> $GITHUB_OUTPUT
              else
                echo "âŒ Code formatting check failed"
                echo "result=failure" >> $GITHUB_OUTPUT
                exit 1
              fi

        - name: ðŸ“ Skip fmt
          if: inputs.run-fmt != 'true'
          id: fmt-skip
          shell: bash
          run: echo "result=skipped" >> $GITHUB_OUTPUT

        - name: ðŸ“Ž Run cargo clippy
          id: clippy
          if: inputs.run-clippy == 'true'
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          run: |
              echo "ðŸ” Running clippy lints..."
              if cargo clippy ${{ steps.flags.outputs.package_flags }} ${{ steps.flags.outputs.feature_flags }} ${{ inputs.clippy-args }}; then
                echo "âœ… Clippy checks passed"
                echo "result=success" >> $GITHUB_OUTPUT
              else
                echo "âŒ Clippy checks failed"
                echo "result=failure" >> $GITHUB_OUTPUT
                exit 1
              fi

        - name: ðŸ“Ž Generate clippy SARIF output
          id: clippy-sarif
          if: inputs.run-clippy == 'true' && always()
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          continue-on-error: true
          run: |
              echo "ðŸ“„ Generating clippy SARIF report..."
              # Install clippy-sarif and sarif-fmt if not already present
              if ! command -v clippy-sarif &>/dev/null; then
                cargo install clippy-sarif sarif-fmt --quiet 2>/dev/null || {
                  echo "âš ï¸ Could not install clippy-sarif â€” skipping SARIF generation"
                  exit 0
                }
              fi
              SARIF_DIR="${{ inputs.working-directory == '.' && '.' || inputs.working-directory }}"
              SARIF_FILE="${SARIF_DIR}/clippy-results.sarif"
              cargo clippy ${{ steps.flags.outputs.package_flags }} ${{ steps.flags.outputs.feature_flags }} \
                --message-format=json ${{ inputs.clippy-args }} 2>/dev/null \
                | clippy-sarif > "$SARIF_FILE" 2>/dev/null || true
              if [ -s "$SARIF_FILE" ]; then
                echo "âœ… SARIF report generated: $SARIF_FILE"
                echo "sarif_file=$SARIF_FILE" >> $GITHUB_OUTPUT
              else
                echo "âš ï¸ SARIF report empty or failed â€” skipping"
                rm -f "$SARIF_FILE"
              fi

        - name: ðŸ“¤ Upload clippy SARIF to GitHub Security tab
          if: inputs.run-clippy == 'true' && steps.clippy-sarif.outputs.sarif_file != '' && always()
          uses: github/codeql-action/upload-sarif@v3
          continue-on-error: true
          with:
              sarif_file: ${{ steps.clippy-sarif.outputs.sarif_file }}
              category: clippy
              wait-for-processing: false

        - name: ðŸ“Ž Skip clippy
          if: inputs.run-clippy != 'true'
          id: clippy-skip
          shell: bash
          run: echo "result=skipped" >> $GITHUB_OUTPUT

        - name: ðŸ”¨ Pre-build packages
          if: inputs.pre-build-packages != ''
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          run: |
              echo "ðŸ”¨ Building prerequisite packages..."
              IFS=',' read -ra PKGS <<< "${{ inputs.pre-build-packages }}"
              for pkg in "${PKGS[@]}"; do
                pkg=$(echo "$pkg" | xargs)
                echo "Building $pkg..."
                cargo build -p $pkg ${{ steps.flags.outputs.feature_flags }}
              done
              echo "âœ… Prerequisite packages built"

        - name: ðŸ—ï¸ Run cargo build
          id: build
          if: inputs.run-build == 'true'
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          run: |
              echo "ðŸ—ï¸ Building project..."
              if cargo build ${{ steps.flags.outputs.release_flag }} ${{ steps.flags.outputs.package_flags }} ${{ steps.flags.outputs.feature_flags }} ${{ inputs.build-args }}; then
                echo "âœ… Build successful"
                echo "result=success" >> $GITHUB_OUTPUT
              else
                echo "âŒ Build failed"
                echo "result=failure" >> $GITHUB_OUTPUT
                exit 1
              fi

        - name: ðŸ—ï¸ Skip build
          if: inputs.run-build != 'true'
          id: build-skip
          shell: bash
          run: echo "result=skipped" >> $GITHUB_OUTPUT

        - name: ðŸ§ª Run cargo test (lib only)
          id: test-lib
          if: inputs.run-tests == 'true' && inputs.test-lib-only == 'true'
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          run: |
              echo "ðŸ§ª Running library tests..."
              if cargo test --lib ${{ steps.flags.outputs.release_flag }} ${{ steps.flags.outputs.package_flags }} ${{ steps.flags.outputs.feature_flags }} ${{ inputs.test-args }}; then
                echo "âœ… Library tests passed"
              else
                echo "âŒ Library tests failed"
                exit 1
              fi

        - name: ðŸ§ª Run cargo test (integration)
          id: test-integration
          if: inputs.run-tests == 'true' && inputs.test-integration == 'true'
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          run: |
              echo "ðŸ§ª Running integration tests..."
              if cargo test --tests ${{ steps.flags.outputs.release_flag }} ${{ steps.flags.outputs.package_flags }} ${{ steps.flags.outputs.feature_flags }} ${{ inputs.test-args }}; then
                echo "âœ… Integration tests passed"
              else
                echo "âŒ Integration tests failed"
                exit 1
              fi

        - name: ðŸ§ª Run cargo test (all)
          id: test
          if: inputs.run-tests == 'true' && inputs.test-lib-only != 'true' && inputs.test-integration != 'true'
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          run: |
              echo "ðŸ§ª Running all tests..."
              if cargo test ${{ steps.flags.outputs.release_flag }} ${{ steps.flags.outputs.package_flags }} ${{ steps.flags.outputs.feature_flags }} ${{ inputs.test-args }}; then
                echo "âœ… All tests passed"
                echo "result=success" >> $GITHUB_OUTPUT
              else
                echo "âŒ Tests failed"
                echo "result=failure" >> $GITHUB_OUTPUT
                exit 1
              fi

        - name: ðŸ§ª Set test result (lib+integration)
          if: inputs.run-tests == 'true' && (inputs.test-lib-only == 'true' || inputs.test-integration == 'true')
          id: test-combined
          shell: bash
          run: echo "result=success" >> $GITHUB_OUTPUT

        - name: ðŸ§ª Skip tests
          if: inputs.run-tests != 'true'
          id: test-skip
          shell: bash
          run: echo "result=skipped" >> $GITHUB_OUTPUT

        - name: ðŸ“Š Generate code coverage
          id: coverage
          if: inputs.coverage == 'true'
          shell: bash
          working-directory: ${{ inputs.working-directory }}
          run: |
              echo "ðŸ“Š Installing cargo-tarpaulin..."
              cargo install cargo-tarpaulin --locked || true

              echo "ðŸ“Š Generating coverage report..."
              mkdir -p ${{ inputs.coverage-output-dir }}
              cargo tarpaulin --out Xml --output-dir ${{ inputs.coverage-output-dir }} ${{ steps.flags.outputs.package_flags }} ${{ steps.flags.outputs.feature_flags }} || true

              COVERAGE_FILE="${{ inputs.coverage-output-dir }}/cobertura.xml"
              if [ -f "$COVERAGE_FILE" ]; then
                echo "âœ… Coverage report generated: $COVERAGE_FILE"
                echo "coverage_file=$COVERAGE_FILE" >> $GITHUB_OUTPUT
              else
                echo "âš ï¸ Coverage file not found"
                echo "coverage_file=" >> $GITHUB_OUTPUT
              fi

        - name: ðŸ“‹ Summary
          if: always()
          shell: bash
          run: |
              # Helper: map step result to emoji
              result_icon() {
                case "$1" in
                  success)  echo "âœ… Passed" ;;
                  failure)  echo "âŒ Failed" ;;
                  skipped)  echo "â­ï¸ Skipped" ;;
                  *)        echo "â“ Unknown" ;;
                esac
              }

              # Resolve actual results from step outputs
              FMT_RESULT="${{ steps.fmt.outputs.result || steps.fmt-skip.outputs.result || 'skipped' }}"
              CLIPPY_RESULT="${{ steps.clippy.outputs.result || steps.clippy-skip.outputs.result || 'skipped' }}"
              TEST_RESULT="${{ steps.test.outputs.result || steps.test-combined.outputs.result || steps.test-skip.outputs.result || 'skipped' }}"
              BUILD_RESULT="${{ steps.build.outputs.result || steps.build-skip.outputs.result || 'skipped' }}"
              BUF_RESULT="${{ steps.buf-lint.outputs.result || 'skipped' }}"

              cat >> $GITHUB_STEP_SUMMARY << EOF
              ## ðŸ¦€ Rust CI Summary

              | Check | Result |
              |-------|--------|
              | Toolchain | \`${{ inputs.toolchain }}\` |
              EOF

              if [ "${{ inputs.run-buf-lint }}" = "true" ]; then
                echo "| Proto Lint (buf) | $(result_icon "$BUF_RESULT") |" >> $GITHUB_STEP_SUMMARY
              fi

              echo "| Format (rustfmt) | $(result_icon "$FMT_RESULT") |" >> $GITHUB_STEP_SUMMARY
              echo "| Lints (clippy) | $(result_icon "$CLIPPY_RESULT") |" >> $GITHUB_STEP_SUMMARY
              echo "| Tests | $(result_icon "$TEST_RESULT") |" >> $GITHUB_STEP_SUMMARY

              if [ "${{ inputs.run-build }}" = "true" ]; then
                MODE="${{ inputs.build-release == 'true' && 'release' || 'debug' }}"
                echo "| Build ($MODE) | $(result_icon "$BUILD_RESULT") |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| Build | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
              fi

              if [ "${{ inputs.coverage }}" = "true" ]; then
                COVERAGE_FILE="${{ steps.coverage.outputs.coverage_file }}"
                if [ -n "$COVERAGE_FILE" ]; then
                  echo "| Coverage | âœ… Generated |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| Coverage | âš ï¸ Not generated |" >> $GITHUB_STEP_SUMMARY
                fi
              fi

              if [ "${{ steps.clippy-sarif.outputs.sarif_file }}" != "" ]; then
                echo "| SARIF Report | âœ… Uploaded |" >> $GITHUB_STEP_SUMMARY
              fi

              # Show workspace info if applicable
              if [ "${{ inputs.workspace }}" = "true" ] || [ -n "${{ inputs.packages }}" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### Workspace Configuration" >> $GITHUB_STEP_SUMMARY
                if [ "${{ inputs.workspace }}" = "true" ]; then
                  echo "- Mode: Full workspace" >> $GITHUB_STEP_SUMMARY
                fi
                if [ -n "${{ inputs.packages }}" ]; then
                  echo "- Packages: \`${{ inputs.packages }}\`" >> $GITHUB_STEP_SUMMARY
                fi
                if [ -n "${{ inputs.exclude-packages }}" ]; then
                  echo "- Excluded: \`${{ inputs.exclude-packages }}\`" >> $GITHUB_STEP_SUMMARY
                fi
                if [ -n "${{ inputs.pre-build-packages }}" ]; then
                  echo "- Pre-built: \`${{ inputs.pre-build-packages }}\`" >> $GITHUB_STEP_SUMMARY
                fi
              fi
