name: 'Rust CI'
description: 'Complete Rust CI pipeline with caching, linting, testing, and building'
author: 'nuniesmith'

branding:
  icon: 'check-circle'
  color: 'orange'

inputs:
  toolchain:
    description: 'Rust toolchain (stable, beta, nightly)'
    required: false
    default: 'stable'
  components:
    description: 'Additional components (comma-separated: rustfmt, clippy, llvm-tools-preview)'
    required: false
    default: 'rustfmt, clippy'
  targets:
    description: 'Additional targets to install (comma-separated)'
    required: false
    default: ''
  run-fmt:
    description: 'Run cargo fmt check'
    required: false
    default: 'true'
  run-clippy:
    description: 'Run cargo clippy'
    required: false
    default: 'true'
  run-tests:
    description: 'Run cargo test'
    required: false
    default: 'true'
  run-build:
    description: 'Run cargo build'
    required: false
    default: 'true'
  build-release:
    description: 'Build in release mode'
    required: false
    default: 'true'
  clippy-args:
    description: 'Additional arguments for clippy'
    required: false
    default: '--all-targets --all-features -- -D warnings'
  test-args:
    description: 'Additional arguments for test'
    required: false
    default: '--verbose'
  build-args:
    description: 'Additional arguments for build'
    required: false
    default: '--verbose'
  features:
    description: 'Features to enable (comma-separated)'
    required: false
    default: ''
  all-features:
    description: 'Enable all features'
    required: false
    default: 'false'
  no-default-features:
    description: 'Disable default features'
    required: false
    default: 'false'
  working-directory:
    description: 'Working directory for cargo commands'
    required: false
    default: '.'
  coverage:
    description: 'Generate code coverage with cargo-tarpaulin'
    required: false
    default: 'false'
  coverage-output-dir:
    description: 'Coverage output directory'
    required: false
    default: './coverage'

outputs:
  fmt-result:
    description: 'Result of fmt check (success/failure/skipped)'
    value: ${{ steps.fmt.outputs.result }}
  clippy-result:
    description: 'Result of clippy (success/failure/skipped)'
    value: ${{ steps.clippy.outputs.result }}
  test-result:
    description: 'Result of tests (success/failure/skipped)'
    value: ${{ steps.test.outputs.result }}
  build-result:
    description: 'Result of build (success/failure/skipped)'
    value: ${{ steps.build.outputs.result }}
  coverage-file:
    description: 'Path to coverage file (if generated)'
    value: ${{ steps.coverage.outputs.coverage_file }}

runs:
  using: 'composite'
  steps:
    - name: ðŸ¦€ Install Rust toolchain
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ inputs.toolchain }}
        components: ${{ inputs.components }}
        targets: ${{ inputs.targets }}

    - name: ðŸ“¦ Cache cargo registry
      uses: actions/cache@v4
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-registry-

    - name: ðŸ“¦ Cache cargo index
      uses: actions/cache@v4
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-git-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-git-

    - name: ðŸ“¦ Cache cargo build
      uses: actions/cache@v4
      with:
        path: target
        key: ${{ runner.os }}-cargo-build-${{ inputs.toolchain }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-build-${{ inputs.toolchain }}-

    - name: ðŸ”§ Prepare feature flags
      id: features
      shell: bash
      run: |
        FEATURE_FLAGS=""

        if [ "${{ inputs.all-features }}" = "true" ]; then
          FEATURE_FLAGS="--all-features"
        elif [ -n "${{ inputs.features }}" ]; then
          FEATURE_FLAGS="--features ${{ inputs.features }}"
        fi

        if [ "${{ inputs.no-default-features }}" = "true" ]; then
          FEATURE_FLAGS="$FEATURE_FLAGS --no-default-features"
        fi

        echo "flags=$FEATURE_FLAGS" >> $GITHUB_OUTPUT

    - name: ðŸ“ Run cargo fmt
      id: fmt
      if: inputs.run-fmt == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸ” Checking code formatting..."
        if cargo fmt --all -- --check; then
          echo "âœ… Code formatting check passed"
          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Code formatting check failed"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: ðŸ“ Skip fmt (not requested)
      if: inputs.run-fmt != 'true'
      id: fmt-skip
      shell: bash
      run: echo "result=skipped" >> $GITHUB_OUTPUT

    - name: ðŸ“Ž Run cargo clippy
      id: clippy
      if: inputs.run-clippy == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸ” Running clippy lints..."
        if cargo clippy ${{ steps.features.outputs.flags }} ${{ inputs.clippy-args }}; then
          echo "âœ… Clippy checks passed"
          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Clippy checks failed"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: ðŸ“Ž Skip clippy (not requested)
      if: inputs.run-clippy != 'true'
      id: clippy-skip
      shell: bash
      run: echo "result=skipped" >> $GITHUB_OUTPUT

    - name: ðŸ§ª Run cargo test
      id: test
      if: inputs.run-tests == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸ§ª Running tests..."
        if cargo test ${{ steps.features.outputs.flags }} ${{ inputs.test-args }}; then
          echo "âœ… All tests passed"
          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Tests failed"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: ðŸ§ª Skip tests (not requested)
      if: inputs.run-tests != 'true'
      id: test-skip
      shell: bash
      run: echo "result=skipped" >> $GITHUB_OUTPUT

    - name: ðŸ—ï¸ Run cargo build
      id: build
      if: inputs.run-build == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸ—ï¸ Building project..."
        RELEASE_FLAG=""
        if [ "${{ inputs.build-release }}" = "true" ]; then
          RELEASE_FLAG="--release"
        fi

        if cargo build $RELEASE_FLAG ${{ steps.features.outputs.flags }} ${{ inputs.build-args }}; then
          echo "âœ… Build successful"
          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "âŒ Build failed"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: ðŸ—ï¸ Skip build (not requested)
      if: inputs.run-build != 'true'
      id: build-skip
      shell: bash
      run: echo "result=skipped" >> $GITHUB_OUTPUT

    - name: ðŸ“Š Generate code coverage
      id: coverage
      if: inputs.coverage == 'true'
      shell: bash
      working-directory: ${{ inputs.working-directory }}
      run: |
        echo "ðŸ“Š Installing cargo-tarpaulin..."
        cargo install cargo-tarpaulin || true

        echo "ðŸ“Š Generating coverage report..."
        mkdir -p ${{ inputs.coverage-output-dir }}
        cargo tarpaulin --out Xml --output-dir ${{ inputs.coverage-output-dir }} ${{ steps.features.outputs.flags }}

        COVERAGE_FILE="${{ inputs.coverage-output-dir }}/cobertura.xml"
        if [ -f "$COVERAGE_FILE" ]; then
          echo "âœ… Coverage report generated: $COVERAGE_FILE"
          echo "coverage_file=$COVERAGE_FILE" >> $GITHUB_OUTPUT
        else
          echo "âš ï¸ Coverage file not found"
          echo "coverage_file=" >> $GITHUB_OUTPUT
        fi

    - name: ðŸ“Š Skip coverage (not requested)
      if: inputs.coverage != 'true'
      id: coverage-skip
      shell: bash
      run: echo "coverage_file=" >> $GITHUB_OUTPUT

    - name: ðŸ“‹ Summary
      shell: bash
      run: |
        echo "## ðŸ¦€ Rust CI Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
        echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Toolchain | \`${{ inputs.toolchain }}\` |" >> $GITHUB_STEP_SUMMARY

        if [ "${{ inputs.run-fmt }}" = "true" ]; then
          echo "| Format (rustfmt) | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Format (rustfmt) | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ inputs.run-clippy }}" = "true" ]; then
          echo "| Lints (clippy) | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Lints (clippy) | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ inputs.run-tests }}" = "true" ]; then
          echo "| Tests | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Tests | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ inputs.run-build }}" = "true" ]; then
          MODE="${{ inputs.build-release == 'true' && 'release' || 'debug' }}"
          echo "| Build ($MODE) | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| Build | â­ï¸ Skipped |" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ inputs.coverage }}" = "true" ]; then
          echo "| Coverage | âœ… Generated |" >> $GITHUB_STEP_SUMMARY
        fi
