# =============================================================================
# FKS CI/CD Pipeline
# =============================================================================
# Streamlined pipeline using reusable composite actions from nuniesmith/actions.
#
# Pipeline Flow:
# 1. Test Gate - Rust CI, Kotlin CI (parallel)
# 2. Docker Build & Push - Multi-service matrix build
# 3. Infrastructure Setup - Tailscale, DNS
# 4. SSL Certificates - Let's Encrypt with self-signed fallback
# 5. Production Deployment - SSH deploy with health checks
# 6. Post-CI - LLM audit, notifications
# =============================================================================

name: ðŸš€ CI/CD Pipeline

on:
    push:
        branches: [main, develop]
        paths-ignore:
            - "**.md"
            - "docs/**"
            - ".github/workflows/llm-audit.yml"
    pull_request:
        branches: [main, develop]
    workflow_dispatch:
        inputs:
            skip_tests:
                description: "Skip tests (deploy only)"
                required: false
                type: boolean
                default: false
            skip_deploy:
                description: "Skip deployment"
                required: false
                type: boolean
                default: false
            skip_ssl:
                description: "Skip SSL certificate generation"
                required: false
                type: boolean
                default: true

permissions:
    contents: write
    pull-requests: write
    packages: write
    checks: write

env:
    RUST_VERSION: "1.92.0"
    CARGO_TERM_COLOR: always
    REDIS_URL: redis://localhost:6379/0
    REGISTRY: docker.io
    IMAGE_NAME: nuniesmith/fks
    DOMAIN: fkstrading.xyz

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

defaults:
    run:
        shell: bash

# =============================================================================
# JOBS
# =============================================================================
jobs:
    # =========================================================================
    # STAGE 1: CODE QUALITY & TESTING
    # =========================================================================

    rust-ci:
        name: ðŸ¦€ Rust CI
        runs-on: ubuntu-latest
        timeout-minutes: 45
        if: ${{ !inputs.skip_tests }}
        services:
            redis:
                image: redis:latest
                ports:
                    - 6379:6379
                options: >-
                    --health-cmd "redis-cli ping"
                    --health-interval 10s
                    --health-timeout 5s
                    --health-retries 5
        steps:
            - name: ðŸ§¹ Free disk space
              run: |
                  sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
                  sudo apt-get clean

            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ¦€ Run Rust CI
              uses: nuniesmith/actions/.github/actions/rust-ci@main
              with:
                  toolchain: ${{ env.RUST_VERSION }}
                  workspace: "true"
                  pre-build-packages: "fks-proto"
                  install-protobuf: "true"
                  install-buf: "true"
                  run-buf-lint: "true"
                  run-buf-breaking: ${{ github.event_name == 'pull_request' }}
                  proto-directory: "proto"
                  run-fmt: "true"
                  run-clippy: "true"
                  clippy-args: "--workspace --lib -- -D warnings -A clippy::too-many-arguments -A clippy::manual-range-contains -A clippy::should-implement-trait"
                  run-build: "true"
                  build-release: "true"
                  run-tests: "true"
                  test-lib-only: "true"
                  test-integration: "true"
                  install-system-deps: "true"
                  additional-apt-packages: "libfontconfig1-dev"
                  cache-key-suffix: "fks-rust"
              env:
                  REDIS_URL: ${{ env.REDIS_URL }}

    kotlin-ci:
        name: ðŸŽ¯ Kotlin/KMP CI
        runs-on: ubuntu-latest
        timeout-minutes: 30
        if: ${{ !inputs.skip_tests }}
        continue-on-error: true
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸŽ¯ Run Kotlin CI
              uses: nuniesmith/actions/.github/actions/kotlin-ci@main
              with:
                  java-version: "21"
                  java-distribution: "temurin"
                  working-directory: "src/clients"
                  run-detekt: "true"
                  run-tests: "true"
                  run-build: "true"
                  test-module: ":shared"
                  test-task: "testDebugUnitTest"
                  build-task: "assemble"
                  known-test-failures: "20"
                  upload-test-results: "true"
                  continue-on-test-failure: "true"

    # =========================================================================
    # TEST GATE - Must pass before proceeding
    # =========================================================================

    test-gate:
        name: ðŸ“Š Test Gate
        runs-on: ubuntu-latest
        timeout-minutes: 5
        needs: [rust-ci, kotlin-ci]
        if: always()
        outputs:
            passed: ${{ steps.check.outputs.passed }}
        steps:
            - name: ðŸ“Š Check test results
              id: check
              run: |
                  echo "# ðŸ§ª Test Gate Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| ðŸ¦€ Rust CI | ${{ needs.rust-ci.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| ðŸŽ¯ Kotlin CI | ${{ needs.kotlin-ci.result }} |" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ needs.rust-ci.result }}" = "failure" ]; then
                    echo "âŒ Rust CI failed - blocking pipeline"
                    echo "passed=false" >> $GITHUB_OUTPUT
                    exit 1
                  elif [ "${{ needs.rust-ci.result }}" = "skipped" ] && [ "${{ needs.kotlin-ci.result }}" = "skipped" ]; then
                    echo "âš ï¸ All tests skipped - proceeding"
                    echo "passed=true" >> $GITHUB_OUTPUT
                  else
                    echo "âœ… Test gate passed"
                    echo "passed=true" >> $GITHUB_OUTPUT
                  fi

    # =========================================================================
    # STAGE 2: DOCKER BUILD & PUSH
    # =========================================================================

    docker-build:
        name: ðŸ³ Docker (${{ matrix.service.name }})
        runs-on: ubuntu-latest
        timeout-minutes: 60
        needs: test-gate
        if: |
            always() &&
            (needs.test-gate.result == 'success' || needs.test-gate.result == 'skipped') &&
            github.event_name == 'push' &&
            (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        strategy:
            fail-fast: false
            matrix:
                service:
                    - name: janus
                      dockerfile: infrastructure/docker/base/rust/Dockerfile
                      target: workspace
                      build_args: SERVICE_NAME=janus
                    - name: execution
                      dockerfile: infrastructure/docker/base/rust/Dockerfile
                      target: execution
                      build_args: SERVICE_NAME=execution
                    - name: optimizer
                      dockerfile: src/optimizer/Dockerfile
                      target: ""
                      build_args: ""
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ³ Build and Push
              uses: nuniesmith/actions/.github/actions/docker-build-push@main
              with:
                  image-name: ${{ env.IMAGE_NAME }}
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_TOKEN }}
                  dockerfile: ${{ matrix.service.dockerfile }}
                  context: "."
                  platforms: "linux/amd64"
                  push: "true"
                  tags: |
                      type=raw,value=${{ matrix.service.name }}-latest
                      type=raw,value=${{ matrix.service.name }}-${{ github.sha }}
                  build-args: ${{ matrix.service.build_args }}

    # =========================================================================
    # STAGE 3: INFRASTRUCTURE SETUP
    # =========================================================================

    infrastructure-setup:
        name: ðŸ” Infrastructure Setup
        runs-on: ubuntu-latest
        timeout-minutes: 15
        needs: docker-build
        if: |
            always() &&
            needs.docker-build.result == 'success' &&
            github.event_name == 'push' &&
            github.ref == 'refs/heads/main' &&
            !inputs.skip_deploy
        outputs:
            tailscale_connected: ${{ steps.tailscale.outputs.connected }}
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: âœ… Validate Tailscale ACL
              run: |
                  jq empty infrastructure/configs/tailscale/tailscale-acl.json || echo "âš ï¸ ACL file not found"

            - name: ðŸ”Œ Connect to Tailscale
              id: tailscale
              uses: nuniesmith/actions/.github/actions/tailscale-connect@main
              with:
                  oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
                  target-ip: ${{ secrets.PROD_TAILSCALE_IP }}

            - name: ðŸŒ Update Cloudflare DNS
              if: steps.tailscale.outputs.connected == 'true'
              uses: nuniesmith/actions/.github/actions/cloudflare-dns-update@main
              with:
                  api-token: ${{ secrets.CLOUDFLARE_API_KEY }}
                  zone-id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
                  record-name: ${{ env.DOMAIN }}
                  record-content: ${{ secrets.PROD_TAILSCALE_IP }}
                  additional-records: '[{"name": "www.${{ env.DOMAIN }}"}]'

    # =========================================================================
    # STAGE 3.5: SSL CERTIFICATES
    # =========================================================================

    ssl-certificates:
        name: ðŸ” SSL Certificates
        runs-on: ubuntu-latest
        timeout-minutes: 15
        needs: infrastructure-setup
        if: |
            always() &&
            needs.infrastructure-setup.result == 'success' &&
            github.event_name == 'push' &&
            github.ref == 'refs/heads/main' &&
            !inputs.skip_deploy &&
            !inputs.skip_ssl
        outputs:
            cert_ready: ${{ steps.ssl.outputs.cert-ready }}
            cert_type: ${{ steps.ssl.outputs.cert-type }}
            deployed: ${{ steps.ssl.outputs.deployed }}
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ”Œ Connect to Tailscale
              uses: nuniesmith/actions/.github/actions/tailscale-connect@main
              with:
                  oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
                  target-ip: ${{ secrets.PROD_TAILSCALE_IP }}

            - name: ðŸ” Generate & Deploy SSL Certificates
              id: ssl
              uses: nuniesmith/actions/.github/actions/ssl-certbot-cloudflare@main
              with:
                  domain: ${{ env.DOMAIN }}
                  additional-domains: "www.${{ env.DOMAIN }}"
                  cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_KEY }}
                  email: ${{ secrets.SSL_EMAIL }}
                  fallback-to-self-signed: "true"
                  self-signed-days: "365"
                  deploy-to-server: "true"
                  ssh-host: ${{ secrets.PROD_TAILSCALE_IP }}
                  ssh-port: ${{ secrets.PROD_SSH_PORT || '22' }}
                  ssh-user: ${{ secrets.PROD_SSH_USER || 'actions' }}
                  ssh-key: ${{ secrets.PROD_SSH_KEY }}
                  docker-volume-name: "fks_certbot_certs"
                  docker-username: ${{ secrets.DOCKER_USERNAME }}
                  docker-token: ${{ secrets.DOCKER_TOKEN }}

    # =========================================================================
    # STAGE 4: PRODUCTION DEPLOYMENT
    # =========================================================================

    deploy-production:
        name: ðŸš€ Deploy to Production
        runs-on: ubuntu-latest
        timeout-minutes: 30
        needs: [docker-build, infrastructure-setup, ssl-certificates]
        if: |
            always() &&
            needs.docker-build.result == 'success' &&
            needs.infrastructure-setup.result == 'success' &&
            (needs.ssl-certificates.result == 'success' || needs.ssl-certificates.result == 'skipped') &&
            github.event_name == 'push' &&
            github.ref == 'refs/heads/main' &&
            !inputs.skip_deploy
        environment:
            name: production
            url: https://fkstrading.xyz
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ”Œ Connect to Tailscale
              uses: nuniesmith/actions/.github/actions/tailscale-connect@main
              with:
                  oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
                  target-ip: ${{ secrets.PROD_TAILSCALE_IP }}
                  target-ssh-port: ${{ secrets.PROD_SSH_PORT || '22' }}

            - name: ðŸš€ Deploy via SSH
              uses: nuniesmith/actions/.github/actions/ssh-deploy@main
              with:
                  host: ${{ secrets.PROD_TAILSCALE_IP }}
                  port: ${{ secrets.PROD_SSH_PORT || '22' }}
                  username: ${{ secrets.PROD_SSH_USER || 'actions' }}
                  ssh-key: ${{ secrets.PROD_SSH_KEY }}
                  project-path: ~/fks
                  git-pull: "true"
                  docker-pull: "true"
                  docker-prune: "true"
                  pre-deploy-command: |
                      if [ ! -d ~/fks/.git ]; then
                        echo "ðŸ“¦ Cloning repository for first-time setup..."
                        rm -rf ~/fks
                        git clone https://github.com/nuniesmith/fks.git ~/fks
                      fi
                  deploy-command: |
                      echo "ðŸ“ Validating .env file..."
                      [ ! -f .env ] && touch .env

                      ensure_env_var() {
                        local VAR_NAME="$1" DEFAULT_VALUE="$2"
                        local CURRENT=$(grep "^${VAR_NAME}=" .env 2>/dev/null | cut -d'=' -f2- | tr -d '[:space:]')
                        if [ -z "$CURRENT" ]; then
                          sed -i "/^${VAR_NAME}=/d" .env
                          echo "${VAR_NAME}=${DEFAULT_VALUE}" >> .env
                        fi
                      }

                      ensure_env_var "POSTGRES_PASSWORD" "$(openssl rand -hex 16)"
                      ensure_env_var "REDIS_PASSWORD" "$(openssl rand -hex 16)"
                      ensure_env_var "QUESTDB_PASSWORD" "$(openssl rand -hex 16)"
                      ensure_env_var "GRAFANA_PASSWORD" "$(openssl rand -hex 16)"
                      ensure_env_var "GRAFANA_USER" "admin"
                      ensure_env_var "TRADING_MODE" "simulation"
                      ensure_env_var "REAL_ORDERS_ENABLED" "false"
                      ensure_env_var "ENABLE_EXECUTION" "true"
                      ensure_env_var "REGISTRY" "docker.io"

                      set -a && source .env && set +a

                      docker compose -f infrastructure/compose/docker-compose.yml \
                        -f infrastructure/compose/docker-compose.prod.yml pull

                      ./run.sh prod up 2>/dev/null || \
                        docker compose -f infrastructure/compose/docker-compose.yml \
                          -f infrastructure/compose/docker-compose.prod.yml up -d

                      docker compose -f infrastructure/compose/docker-compose.yml \
                        -f infrastructure/compose/docker-compose.prod.yml ps
                  post-deploy-command: |
                      echo "âœ… FKS services deployed"

            - name: ðŸ¥ Health check
              timeout-minutes: 5
              continue-on-error: true
              run: |
                  sleep 30
                  curl -sSf https://${{ env.DOMAIN }}/health > /dev/null 2>&1 && \
                    echo "âœ… Health check passed" || \
                    echo "âš ï¸ Health check failed - manual verification needed"

            - name: ðŸ“£ Notify deployment
              if: always()
              uses: nuniesmith/actions/.github/actions/discord-notify@main
              continue-on-error: true
              with:
                  webhook-url: ${{ secrets.DISCORD_WEBHOOK_GITHUB }}
                  title: "${{ job.status == 'success' && 'ðŸš€ FKS Deployed' || 'âŒ FKS Deploy Failed' }}"
                  description: "${{ job.status == 'success' && 'Services deployed to production' || 'Deployment failed - check logs' }}"
                  status: ${{ job.status == 'success' && 'success' || 'failure' }}
                  include-repo-info: "true"
                  fields: |
                      [
                        {"name": "Environment", "value": "production", "inline": true},
                        {"name": "Domain", "value": "${{ env.DOMAIN }}", "inline": true},
                        {"name": "SSL Certificate", "value": "${{ needs.ssl-certificates.outputs.cert_type || 'skipped' }}", "inline": true}
                      ]

    # =========================================================================
    # STAGE 5: POST-CI ANALYSIS
    # =========================================================================

    llm-audit:
        name: ðŸ§  LLM Audit
        runs-on: ubuntu-latest
        timeout-minutes: 45
        needs: [rust-ci, kotlin-ci]
        if: |
            always() &&
            (needs.rust-ci.result == 'success' || needs.rust-ci.result == 'failure') &&
            github.event_name != 'workflow_dispatch'
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 50

            - name: ðŸ“Š Collect changed files
              id: changes
              run: |
                  if [ "${{ github.event_name }}" = "push" ] && [ -n "${{ github.event.before }}" ]; then
                    CHANGED=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }} 2>/dev/null | wc -l || echo "0")
                  else
                    CHANGED=$(git diff --name-only HEAD~1 2>/dev/null | wc -l || echo "0")
                  fi
                  echo "count=$CHANGED" >> $GITHUB_OUTPUT

            - name: ðŸ¤– Run LLM Audit
              if: steps.changes.outputs.count != '0'
              uses: nuniesmith/actions/.github/actions/llm-audit@main
              with:
                  provider: "xai"
                  audit-mode: "regular"
                  source-path: "src"
                  file-patterns: "*.rs,*.kt"
                  exclude-patterns: "target/*,build/*,.git/*"
                  output-dir: "./audit-results"
                  max-files: "30"
                  xai-api-key: ${{ secrets.XAI_API_KEY }}
                  upload-artifacts: "true"
                  commit-results: "false"

            - name: ðŸ’¬ PR Comment with Results
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              continue-on-error: true
              with:
                  script: |
                      const fs = require('fs');
                      let body = '## ðŸ§  LLM Code Audit\n\n';
                      try {
                        if (fs.existsSync('./audit-results/audit-report.json')) {
                          const data = JSON.parse(fs.readFileSync('./audit-results/audit-report.json', 'utf8'));
                          body += `**Files Analyzed:** ${data.files_analyzed || 0}\n`;
                        } else {
                          body += 'No audit results available.\n';
                        }
                      } catch (e) {
                        body += `Error: ${e.message}\n`;
                      }
                      await github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: body
                      });

    # =========================================================================
    # PIPELINE SUMMARY
    # =========================================================================

    pipeline-summary:
        name: ðŸ“Š Pipeline Summary
        runs-on: ubuntu-latest
        timeout-minutes: 5
        needs:
            - rust-ci
            - kotlin-ci
            - test-gate
            - docker-build
            - infrastructure-setup
            - ssl-certificates
            - deploy-production
            - llm-audit
        if: always()
        steps:
            - name: ðŸ“Š Generate summary
              run: |
                  cat >> $GITHUB_STEP_SUMMARY << EOF
                  # ðŸš€ FKS CI/CD Pipeline Summary

                  ## Test Stage
                  | Job | Status |
                  |-----|--------|
                  | ðŸ¦€ Rust CI | ${{ needs.rust-ci.result || 'skipped' }} |
                  | ðŸŽ¯ Kotlin CI | ${{ needs.kotlin-ci.result || 'skipped' }} |
                  | ðŸ“Š Test Gate | ${{ needs.test-gate.result || 'skipped' }} |

                  ## Build & Deploy Stage
                  | Job | Status |
                  |-----|--------|
                  | ðŸ³ Docker Build | ${{ needs.docker-build.result || 'skipped' }} |
                  | ðŸ” Infrastructure | ${{ needs.infrastructure-setup.result || 'skipped' }} |
                  | ðŸ”’ SSL Certificates | ${{ needs.ssl-certificates.result || 'skipped' }} |
                  | ðŸš€ Deploy | ${{ needs.deploy-production.result || 'skipped' }} |

                  ## SSL Details
                  | Property | Value |
                  |----------|-------|
                  | Certificate Type | ${{ needs.ssl-certificates.outputs.cert_type || 'N/A' }} |
                  | Certificate Ready | ${{ needs.ssl-certificates.outputs.cert_ready || 'N/A' }} |
                  | Deployed to Server | ${{ needs.ssl-certificates.outputs.deployed || 'N/A' }} |

                  ## Post-CI
                  | Job | Status |
                  |-----|--------|
                  | ðŸ§  LLM Audit | ${{ needs.llm-audit.result || 'skipped' }} |

                  ---
                  **Branch:** \`${{ github.ref_name }}\` | **Commit:** \`${{ github.sha }}\` | **Actor:** \`${{ github.actor }}\`
                  EOF

            - name: âŒ Fail on critical errors
              if: |
                  needs.rust-ci.result == 'failure' ||
                  needs.docker-build.result == 'failure' ||
                  needs.deploy-production.result == 'failure'
              run: |
                  echo "âŒ Pipeline failed due to critical job failure"
                  exit 1
