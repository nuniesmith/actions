# =============================================================================
# FKS CI/CD Pipeline
# =============================================================================
# Streamlined pipeline using reusable composite actions from nuniesmith/actions.
#
# Pipeline Flow:
# 1. Docker Build & Push - Multi-service matrix build
# 2. Infrastructure Setup - Tailscale, DNS
# 3. SSL Certificates - Let's Encrypt with self-signed fallback
# 4. Deployment - Staging (develop) or Production (main)
# 5. Health Checks - Verify deployment success
# 6. Post-CI - LLM audit, notifications
#
# NOTE: Tests are currently disabled to focus on deployment process
# =============================================================================

name: ðŸš€ CI/CD Pipeline

on:
    push:
        branches: [main, develop]
        paths-ignore:
            - "**.md"
            - "docs/**"
            - ".github/workflows/llm-audit.yml"
    pull_request:
        branches: [main, develop]
    workflow_dispatch:
        inputs:
            skip_deploy:
                description: "Skip deployment"
                required: false
                type: boolean
                default: false
            skip_ssl:
                description: "Skip SSL certificate generation"
                required: false
                type: boolean
                default: true
            environment:
                description: "Target environment"
                required: false
                type: choice
                options:
                    - auto
                    - staging
                    - production
                default: auto

permissions:
    contents: write
    pull-requests: write
    packages: write
    checks: write

env:
    RUST_VERSION: "1.87.0"
    CARGO_TERM_COLOR: always
    REDIS_URL: redis://localhost:6379/0
    REGISTRY: docker.io
    IMAGE_NAME: nuniesmith/fks
    DOMAIN: fkstrading.xyz
    STAGING_DOMAIN: staging.fkstrading.xyz

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

defaults:
    run:
        shell: bash

# =============================================================================
# JOBS
# =============================================================================
jobs:
    # =========================================================================
    # STAGE 1: ENVIRONMENT SETUP
    # =========================================================================

    setup:
        name: ðŸ“‹ Setup
        runs-on: ubuntu-latest
        timeout-minutes: 5
        outputs:
            deploy_env: ${{ steps.determine-env.outputs.environment }}
        steps:
            - name: ðŸŽ¯ Determine deployment environment
              id: determine-env
              run: |
                  # Check workflow dispatch input first
                  if [ "${{ inputs.environment }}" != "" ] && [ "${{ inputs.environment }}" != "auto" ]; then
                    ENV="${{ inputs.environment }}"
                  elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
                    ENV="production"
                  elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
                    ENV="staging"
                  else
                    ENV="none"
                  fi

                  echo "environment=$ENV" >> $GITHUB_OUTPUT
                  echo "ðŸ“ Target environment: $ENV"

                  echo "## ðŸ“‹ Pipeline Configuration" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Environment | \`$ENV\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| Branch | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
                  echo "| Tests | \`disabled\` |" >> $GITHUB_STEP_SUMMARY

    # =========================================================================
    # STAGE 2: DOCKER BUILD & PUSH
    # =========================================================================

    docker-build:
        name: ðŸ³ Docker (${{ matrix.service.name }})
        runs-on: ubuntu-latest
        timeout-minutes: 60
        needs: setup
        if: |
            github.event_name == 'push' &&
            (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
        strategy:
            fail-fast: false
            matrix:
                service:
                    - name: janus
                      dockerfile: infrastructure/docker/base/rust/Dockerfile
                      target: workspace
                      build_args: SERVICE_NAME=janus
                    - name: execution
                      dockerfile: infrastructure/docker/base/rust/Dockerfile
                      target: execution
                      build_args: SERVICE_NAME=execution
                    - name: optimizer
                      dockerfile: src/optimizer/Dockerfile
                      target: ""
                      build_args: ""
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ³ Build and Push
              uses: nuniesmith/actions/.github/actions/docker-build-push@main
              with:
                  image-name: ${{ env.IMAGE_NAME }}
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_TOKEN }}
                  dockerfile: ${{ matrix.service.dockerfile }}
                  context: "."
                  platforms: "linux/amd64"
                  push: "true"
                  tags: |
                      type=raw,value=${{ matrix.service.name }}-latest
                      type=raw,value=${{ matrix.service.name }}-${{ github.sha }}
                      type=raw,value=${{ matrix.service.name }}-${{ needs.setup.outputs.deploy_env }}
                  build-args: ${{ matrix.service.build_args }}

    # =========================================================================
    # STAGE 3: INFRASTRUCTURE SETUP
    # =========================================================================

    infrastructure-setup:
        name: ðŸ” Infrastructure (${{ needs.setup.outputs.deploy_env }})
        runs-on: ubuntu-latest
        timeout-minutes: 15
        needs: [setup, docker-build]
        if: |
            needs.docker-build.result == 'success' &&
            github.event_name == 'push' &&
            (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') &&
            !inputs.skip_deploy
        outputs:
            tailscale_connected: ${{ steps.tailscale.outputs.connected }}
            target_host: ${{ steps.config.outputs.host }}
            target_domain: ${{ steps.config.outputs.domain }}
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: âš™ï¸ Configure environment
              id: config
              run: |
                  ENV="${{ needs.setup.outputs.deploy_env }}"
                  if [ "$ENV" = "production" ]; then
                    echo "host=${{ secrets.PROD_TAILSCALE_IP }}" >> $GITHUB_OUTPUT
                    echo "domain=${{ env.DOMAIN }}" >> $GITHUB_OUTPUT
                    echo "ssh_port=${{ secrets.PROD_SSH_PORT || '22' }}" >> $GITHUB_OUTPUT
                  else
                    echo "host=${{ secrets.STAGING_TAILSCALE_IP || secrets.PROD_TAILSCALE_IP }}" >> $GITHUB_OUTPUT
                    echo "domain=${{ env.STAGING_DOMAIN }}" >> $GITHUB_OUTPUT
                    echo "ssh_port=${{ secrets.STAGING_SSH_PORT || secrets.PROD_SSH_PORT || '22' }}" >> $GITHUB_OUTPUT
                  fi

            - name: âœ… Validate Tailscale ACL
              run: |
                  jq empty infrastructure/configs/tailscale/tailscale-acl.json || echo "âš ï¸ ACL file not found"

            - name: ðŸ”Œ Connect to Tailscale
              id: tailscale
              uses: nuniesmith/actions/.github/actions/tailscale-connect@main
              with:
                  oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
                  target-ip: ${{ steps.config.outputs.host }}

            - name: ðŸŒ Update Cloudflare DNS
              if: steps.tailscale.outputs.connected == 'true'
              uses: nuniesmith/actions/.github/actions/cloudflare-dns-update@main
              with:
                  api-token: ${{ secrets.CLOUDFLARE_API_KEY }}
                  zone-id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
                  record-name: ${{ steps.config.outputs.domain }}
                  record-content: ${{ steps.config.outputs.host }}
                  additional-records: '[{"name": "www.${{ steps.config.outputs.domain }}"}]'

    # =========================================================================
    # STAGE 3.5: SSL CERTIFICATES
    # =========================================================================

    ssl-certificates:
        name: ðŸ” SSL Certificates
        runs-on: ubuntu-latest
        timeout-minutes: 15
        needs: [setup, infrastructure-setup]
        if: |
            needs.infrastructure-setup.result == 'success' &&
            github.event_name == 'push' &&
            github.ref == 'refs/heads/main' &&
            !inputs.skip_deploy &&
            !inputs.skip_ssl
        outputs:
            cert_ready: ${{ steps.ssl.outputs.cert-ready }}
            cert_type: ${{ steps.ssl.outputs.cert-type }}
            deployed: ${{ steps.ssl.outputs.deployed }}
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ”Œ Connect to Tailscale
              uses: nuniesmith/actions/.github/actions/tailscale-connect@main
              with:
                  oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
                  target-ip: ${{ needs.infrastructure-setup.outputs.target_host }}

            - name: ðŸ” Generate & Deploy SSL Certificates
              id: ssl
              uses: nuniesmith/actions/.github/actions/ssl-certbot-cloudflare@main
              with:
                  domain: ${{ needs.infrastructure-setup.outputs.target_domain }}
                  additional-domains: "www.${{ needs.infrastructure-setup.outputs.target_domain }}"
                  cloudflare-api-token: ${{ secrets.CLOUDFLARE_API_KEY }}
                  email: ${{ secrets.SSL_EMAIL }}
                  fallback-to-self-signed: "true"
                  self-signed-days: "365"
                  deploy-to-server: "true"
                  ssh-host: ${{ needs.infrastructure-setup.outputs.target_host }}
                  ssh-port: ${{ secrets.PROD_SSH_PORT || '22' }}
                  ssh-user: ${{ secrets.PROD_SSH_USER || 'actions' }}
                  ssh-key: ${{ secrets.PROD_SSH_KEY }}
                  docker-volume-name: "fks_certbot_certs"
                  docker-username: ${{ secrets.DOCKER_USERNAME }}
                  docker-token: ${{ secrets.DOCKER_TOKEN }}

    # =========================================================================
    # STAGE 4: DEPLOYMENT
    # =========================================================================

    deploy:
        name: ðŸš€ Deploy to ${{ needs.setup.outputs.deploy_env }}
        runs-on: ubuntu-latest
        timeout-minutes: 30
        needs: [setup, docker-build, infrastructure-setup, ssl-certificates]
        if: |
            always() &&
            needs.docker-build.result == 'success' &&
            needs.infrastructure-setup.result == 'success' &&
            (needs.ssl-certificates.result == 'success' || needs.ssl-certificates.result == 'skipped') &&
            github.event_name == 'push' &&
            (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') &&
            !inputs.skip_deploy
        environment:
            name: ${{ needs.setup.outputs.deploy_env }}
            url: https://${{ needs.infrastructure-setup.outputs.target_domain }}
        outputs:
            deployed: ${{ steps.deploy.outputs.deployed }}
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ”Œ Connect to Tailscale
              uses: nuniesmith/actions/.github/actions/tailscale-connect@main
              with:
                  oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
                  target-ip: ${{ needs.infrastructure-setup.outputs.target_host }}
                  target-ssh-port: ${{ secrets.PROD_SSH_PORT || '22' }}

            - name: ðŸš€ Deploy via SSH
              id: deploy
              uses: nuniesmith/actions/.github/actions/ssh-deploy@main
              with:
                  host: ${{ needs.infrastructure-setup.outputs.target_host }}
                  port: ${{ secrets.PROD_SSH_PORT || '22' }}
                  username: ${{ secrets.PROD_SSH_USER || 'actions' }}
                  ssh-key: ${{ secrets.PROD_SSH_KEY }}
                  project-path: ~/fks
                  git-pull: "true"
                  git-branch: ${{ github.ref_name }}
                  docker-pull: "true"
                  docker-prune: "false"
                  pre-deploy-command: |
                      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                      echo "ðŸ“‹ PRE-DEPLOY: ${{ needs.setup.outputs.deploy_env }}"
                      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

                      # System info
                      echo "ðŸ–¥ï¸  Host: $(hostname) | $(date)"
                      echo "ðŸ’¾ Disk: $(df -h / | tail -1 | awk '{print $4}') free | Memory: $(free -h | grep Mem | awk '{print $7}') available"

                      # First-time setup
                      if [ ! -d ~/fks/.git ]; then
                        echo "ðŸ“¦ First-time setup - cloning repository..."
                        rm -rf ~/fks
                        git clone https://github.com/nuniesmith/fks.git ~/fks
                      fi

                      # Ensure Docker volumes
                      echo "ðŸ“¦ Ensuring Docker volumes..."
                      for vol in fks_certbot_www fks_certbot_conf fks_postgres_data fks_questdb_data fks_redis_data fks_grafana_data fks_prometheus_data fks_loki_data fks_alertmanager_data; do
                        docker volume create $vol 2>/dev/null || true
                      done
                      echo "âœ… Volumes ready"

                  deploy-command: |
                      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                      echo "ðŸš€ DEPLOYING: ${{ needs.setup.outputs.deploy_env }}"
                      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

                      # Docker login
                      echo "${{ secrets.DOCKER_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin docker.io || true

                      # Environment setup
                      [ ! -f .env ] && touch .env

                      # Ensure required env vars
                      ensure_env() {
                        local VAR="$1" DEFAULT="$2"
                        grep -q "^${VAR}=" .env || echo "${VAR}=${DEFAULT}" >> .env
                      }

                      ensure_env "POSTGRES_PASSWORD" "$(openssl rand -hex 16)"
                      ensure_env "REDIS_PASSWORD" "$(openssl rand -hex 16)"
                      ensure_env "QUESTDB_PASSWORD" "$(openssl rand -hex 16)"
                      ensure_env "GRAFANA_PASSWORD" "$(openssl rand -hex 16)"
                      ensure_env "GRAFANA_USER" "admin"
                      ensure_env "TRADING_MODE" "simulation"
                      ensure_env "REAL_ORDERS_ENABLED" "false"
                      ensure_env "ENABLE_EXECUTION" "true"
                      ensure_env "REGISTRY" "docker.io"
                      ensure_env "IMAGE_NAME" "nuniesmith/fks"
                      ensure_env "ENVIRONMENT" "${{ needs.setup.outputs.deploy_env }}"

                      set -a && source .env && set +a

                      COMPOSE_CMD="docker compose -f infrastructure/compose/docker-compose.yml -f infrastructure/compose/docker-compose.prod.yml"

                      # Stop existing
                      echo "ðŸ›‘ Stopping containers..."
                      $COMPOSE_CMD down --remove-orphans 2>/dev/null || true

                      # Pull images
                      echo "ðŸ“¥ Pulling images..."
                      for svc in janus execution optimizer; do
                        docker pull ${REGISTRY}/${IMAGE_NAME}:${svc}-latest 2>&1 | tail -1 || echo "âš ï¸ ${svc} pull failed"
                      done

                      # Start
                      echo "ðŸš€ Starting containers..."
                      $COMPOSE_CMD up -d 2>&1

                      # Wait and check
                      echo "â³ Waiting for containers..."
                      sleep 15

                      RUNNING=$(docker ps --filter "name=fks" --format '{{.Names}}' | wc -l)
                      echo "âœ… Running: $RUNNING containers"

                      if [ "$RUNNING" -eq 0 ]; then
                        echo "âŒ No containers running!"
                        docker ps -a --filter "name=fks" --format "table {{.Names}}\t{{.Status}}" | head -10
                        exit 1
                      fi

                  post-deploy-command: |
                      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                      echo "ðŸ§¹ POST-DEPLOY CLEANUP"
                      echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

                      # Cleanup old images (keep 24h)
                      docker image prune -f --filter "until=24h" 2>/dev/null || true

                      echo ""
                      echo "ðŸŒ Access URLs:"
                      echo "   Grafana:    http://$(hostname -I | awk '{print $1}'):3000"
                      echo "   Prometheus: http://$(hostname -I | awk '{print $1}'):9090"
                      echo "   QuestDB:    http://$(hostname -I | awk '{print $1}'):9000"
                      echo ""
                      echo "âœ… Deployment complete!"

    # =========================================================================
    # STAGE 5: HEALTH CHECKS
    # =========================================================================

    health-check:
        name: ðŸ¥ Health Check
        runs-on: ubuntu-latest
        timeout-minutes: 10
        needs: [setup, infrastructure-setup, deploy]
        if: |
            needs.deploy.result == 'success'
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ”Œ Connect to Tailscale
              uses: nuniesmith/actions/.github/actions/tailscale-connect@main
              with:
                  oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
                  target-ip: ${{ needs.infrastructure-setup.outputs.target_host }}

            - name: ðŸ¥ Run Health Checks
              uses: nuniesmith/actions/.github/actions/health-check@main
              with:
                  endpoints: |
                      [
                        {"url": "https://${{ needs.infrastructure-setup.outputs.target_domain }}/health", "expected_status": 200},
                        {"url": "http://${{ needs.infrastructure-setup.outputs.target_host }}:3000/api/health", "expected_status": 200},
                        {"url": "http://${{ needs.infrastructure-setup.outputs.target_host }}:9090/-/healthy", "expected_status": 200}
                      ]
                  containers: "fks_postgres fks_redis fks_questdb fks_prometheus fks_grafana"
                  ssh-host: ${{ needs.infrastructure-setup.outputs.target_host }}
                  ssh-port: ${{ secrets.PROD_SSH_PORT || '22' }}
                  ssh-user: ${{ secrets.PROD_SSH_USER || 'actions' }}
                  ssh-key: ${{ secrets.PROD_SSH_KEY }}
                  initial-delay: "30"
                  retry-count: "3"
                  retry-delay: "10"
                  fail-on-unhealthy: "false"

            - name: ðŸ“£ Notify deployment
              if: always()
              uses: nuniesmith/actions/.github/actions/discord-notify@main
              continue-on-error: true
              with:
                  webhook-url: ${{ secrets.DISCORD_WEBHOOK_GITHUB }}
                  title: "${{ needs.deploy.result == 'success' && 'ðŸš€ FKS Deployed' || 'âŒ FKS Deploy Failed' }}"
                  description: "Deployed to ${{ needs.setup.outputs.deploy_env }}"
                  status: ${{ needs.deploy.result == 'success' && 'success' || 'failure' }}
                  include-repo-info: "true"
                  fields: |
                      [
                        {"name": "Environment", "value": "${{ needs.setup.outputs.deploy_env }}", "inline": true},
                        {"name": "Domain", "value": "${{ needs.infrastructure-setup.outputs.target_domain }}", "inline": true},
                        {"name": "SSL", "value": "${{ needs.ssl-certificates.outputs.cert_type || 'skipped' }}", "inline": true}
                      ]

    # =========================================================================
    # STAGE 6: POST-CI ANALYSIS
    # =========================================================================

    llm-audit:
        name: ðŸ§  LLM Audit
        runs-on: ubuntu-latest
        timeout-minutes: 45
        needs: [deploy]
        if: |
            always() &&
            needs.deploy.result == 'success' &&
            github.event_name != 'workflow_dispatch'
        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 50

            - name: ðŸ“Š Collect changed files
              id: changes
              run: |
                  if [ "${{ github.event_name }}" = "push" ] && [ -n "${{ github.event.before }}" ]; then
                    CHANGED=$(git diff --name-only ${{ github.event.before }}..${{ github.sha }} 2>/dev/null | wc -l || echo "0")
                  else
                    CHANGED=$(git diff --name-only HEAD~1 2>/dev/null | wc -l || echo "0")
                  fi
                  echo "count=$CHANGED" >> $GITHUB_OUTPUT

            - name: ðŸ¤– Run LLM Audit
              if: steps.changes.outputs.count != '0'
              uses: nuniesmith/actions/.github/actions/llm-audit@main
              with:
                  provider: "xai"
                  audit-mode: "regular"
                  source-path: "src"
                  file-patterns: "*.rs,*.kt"
                  exclude-patterns: "target/*,build/*,.git/*"
                  output-dir: "./audit-results"
                  max-files: "30"
                  xai-api-key: ${{ secrets.XAI_API_KEY }}
                  upload-artifacts: "true"
                  commit-results: "false"

            - name: ðŸ’¬ PR Comment with Results
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              continue-on-error: true
              with:
                  script: |
                      const fs = require('fs');
                      let body = '## ðŸ§  LLM Code Audit\n\n';
                      try {
                        if (fs.existsSync('./audit-results/audit-report.json')) {
                          const data = JSON.parse(fs.readFileSync('./audit-results/audit-report.json', 'utf8'));
                          body += `**Files Analyzed:** ${data.files_analyzed || 0}\n`;
                        } else {
                          body += 'No audit results available.\n';
                        }
                      } catch (e) {
                        body += `Error: ${e.message}\n`;
                      }
                      await github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: body
                      });

    # =========================================================================
    # PIPELINE SUMMARY
    # =========================================================================

    pipeline-summary:
        name: ðŸ“Š Pipeline Summary
        runs-on: ubuntu-latest
        timeout-minutes: 5
        needs:
            - setup
            - docker-build
            - infrastructure-setup
            - ssl-certificates
            - deploy
            - health-check
            - llm-audit
        if: always()
        steps:
            - name: ðŸ“Š Generate summary
              run: |
                  ENV="${{ needs.setup.outputs.deploy_env || 'N/A' }}"
                  DOMAIN="${{ needs.infrastructure-setup.outputs.target_domain || 'N/A' }}"

                  cat >> $GITHUB_STEP_SUMMARY << EOF
                  # ðŸš€ FKS CI/CD Pipeline Summary

                  ## Environment
                  | Property | Value |
                  |----------|-------|
                  | Target | \`$ENV\` |
                  | Domain | \`$DOMAIN\` |
                  | Branch | \`${{ github.ref_name }}\` |
                  | Commit | \`${{ github.sha }}\` |

                  ## Build & Deploy Stage
                  | Job | Status |
                  |-----|--------|
                  | ðŸ³ Docker Build | ${{ needs.docker-build.result || 'skipped' }} |
                  | ðŸ” Infrastructure | ${{ needs.infrastructure-setup.result || 'skipped' }} |
                  | ðŸ”’ SSL Certificates | ${{ needs.ssl-certificates.result || 'skipped' }} |
                  | ðŸš€ Deploy | ${{ needs.deploy.result || 'skipped' }} |
                  | ðŸ¥ Health Check | ${{ needs.health-check.result || 'skipped' }} |

                  ## SSL Details
                  | Property | Value |
                  |----------|-------|
                  | Certificate Type | ${{ needs.ssl-certificates.outputs.cert_type || 'N/A' }} |
                  | Certificate Ready | ${{ needs.ssl-certificates.outputs.cert_ready || 'N/A' }} |
                  | Deployed | ${{ needs.ssl-certificates.outputs.deployed || 'N/A' }} |

                  ## Post-CI
                  | Job | Status |
                  |-----|--------|
                  | ðŸ§  LLM Audit | ${{ needs.llm-audit.result || 'skipped' }} |

                  ---
                  **Actor:** \`${{ github.actor }}\` | **Workflow:** \`${{ github.run_number }}\`
                  EOF

            - name: âŒ Fail on critical errors
              if: |
                  needs.docker-build.result == 'failure' ||
                  needs.deploy.result == 'failure'
              run: |
                  echo "âŒ Pipeline failed due to critical job failure"
                  exit 1
