# Docker Compose Configuration Example for Freddy Nginx with Host-Based SSL
# ===========================================================================
# This example shows how to configure nginx to use SSL certificates from the
# host filesystem (/etc/letsencrypt) instead of Docker volumes.
#
# Key Points:
# - Certificates are stored at /etc/letsencrypt on the host
# - Nginx mounts /etc/letsencrypt as read-only
# - No Docker volume needed for SSL certificates
# - Easier to manage and no permission issues

version: '3.8'

services:
  # ============================================================================
  # Nginx Reverse Proxy
  # ============================================================================
  nginx:
    container_name: nginx
    image: nginx:alpine
    restart: unless-stopped

    # Network configuration
    networks:
      - freddy_network

    ports:
      - "80:80"
      - "443:443"

    # Volume mounts
    volumes:
      # SSL Certificates - MOUNTED FROM HOST FILESYSTEM
      # The host stores certificates at /etc/letsencrypt
      # CI/CD deploys certificates directly to this path
      # Nginx reads them as read-only (:ro) for security
      - /etc/letsencrypt:/etc/letsencrypt:ro

      # Nginx configuration files
      - ./config/nginx:/etc/nginx/conf.d:ro

      # Optional: Custom nginx.conf
      # - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro

      # Optional: Static files, logs, etc.
      # - ./static:/var/www/html:ro
      # - ./logs/nginx:/var/log/nginx

    # Environment variables
    environment:
      - DOMAIN=7gram.xyz
      - TZ=America/Toronto

    # Health check
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    # Custom entrypoint (optional - if you have custom SSL setup logic)
    # entrypoint: /docker-entrypoint.sh

    depends_on:
      - photoprism
      - nextcloud
      - homeassistant

  # ============================================================================
  # Other Services (examples)
  # ============================================================================

  photoprism:
    container_name: photoprism
    image: photoprism/photoprism:latest
    restart: unless-stopped
    networks:
      - freddy_network
    # ... other photoprism config ...

  nextcloud:
    container_name: nextcloud
    image: nextcloud:latest
    restart: unless-stopped
    networks:
      - freddy_network
    # ... other nextcloud config ...

  homeassistant:
    container_name: homeassistant
    image: homeassistant/home-assistant:latest
    restart: unless-stopped
    networks:
      - freddy_network
    # ... other homeassistant config ...

# ============================================================================
# Networks
# ============================================================================
networks:
  freddy_network:
    driver: bridge

# ============================================================================
# Volumes
# ============================================================================
# NOTE: No ssl-certs volume needed!
# Certificates are stored on the host filesystem at /etc/letsencrypt
# and mounted directly into the nginx container.
#
# If you were previously using a Docker volume, you can remove it:
# volumes:
#   ssl-certs:  # <-- NO LONGER NEEDED
#     external: true

volumes:
  # Other volumes for your services
  photoprism_storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/1tb/photoprism

  nextcloud_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/1tb/nextcloud

# ============================================================================
# Migration Notes
# ============================================================================
#
# To migrate from Docker volume to host path:
#
# 1. Stop services:
#    docker compose down
#
# 2. Create directory on host:
#    sudo mkdir -p /etc/letsencrypt
#
# 3. Copy existing certificates (if you have them in a volume):
#    docker run --rm \
#      -v ssl-certs:/certs:ro \
#      -v /etc/letsencrypt:/dest \
#      busybox:latest \
#      cp -r /certs/* /dest/
#
# 4. Set permissions:
#    sudo chmod -R 755 /etc/letsencrypt
#    sudo chmod 600 /etc/letsencrypt/archive/*/privkey*.pem
#
# 5. Update this docker-compose.yml (replace volume mount)
#
# 6. Start services:
#    docker compose up -d
#
# 7. Verify:
#    docker exec nginx ls -la /etc/letsencrypt/live/
#
# ============================================================================
