# ============================================================================
# Docker Compose Configuration for Freddy Server
# ============================================================================
# Personal home server running photos, cloud storage, home automation
# All services proxied through nginx with Let's Encrypt SSL certificates
#
# Services:
#   - nginx: Reverse proxy with SSL termination
#   - photoprism: Photo management (photo.7gram.xyz)
#   - nextcloud: Cloud storage (nc.7gram.xyz)
#   - homeassistant: Home automation (home.7gram.xyz)
#   - audiobookshelf: Audiobook server (audiobook.7gram.xyz)
# ============================================================================

version: '3.8'

services:
  # ==========================================================================
  # NGINX - Reverse Proxy with SSL
  # ==========================================================================
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      # SSL certificates from Docker volume (generated by CI/CD)
      - ssl-certs:/etc/letsencrypt:ro
      # Nginx configuration files
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      # ACME challenge directory (for cert renewal)
      - ./nginx/certbot:/var/www/certbot:ro
    networks:
      - freddy-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    depends_on:
      - photoprism
      - nextcloud
      - homeassistant
      - audiobookshelf

  # ==========================================================================
  # PHOTOPRISM - Photo Management
  # ==========================================================================
  photoprism:
    image: photoprism/photoprism:latest
    container_name: photoprism
    restart: unless-stopped
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    environment:
      PHOTOPRISM_ADMIN_USER: "${PHOTOPRISM_ADMIN_USER:-admin}"
      PHOTOPRISM_ADMIN_PASSWORD: "${PHOTOPRISM_ADMIN_PASSWORD}"
      PHOTOPRISM_AUTH_MODE: "password"
      PHOTOPRISM_SITE_URL: "https://photo.7gram.xyz/"
      PHOTOPRISM_ORIGINALS_LIMIT: 5000
      PHOTOPRISM_HTTP_COMPRESSION: "gzip"
      PHOTOPRISM_LOG_LEVEL: "info"
      PHOTOPRISM_READONLY: "false"
      PHOTOPRISM_EXPERIMENTAL: "false"
      PHOTOPRISM_DISABLE_CHOWN: "false"
      PHOTOPRISM_DISABLE_WEBDAV: "false"
      PHOTOPRISM_DISABLE_SETTINGS: "false"
      PHOTOPRISM_DISABLE_TENSORFLOW: "false"
      PHOTOPRISM_DISABLE_FACES: "false"
      PHOTOPRISM_DISABLE_CLASSIFICATION: "false"
      PHOTOPRISM_DISABLE_RAW: "false"
      PHOTOPRISM_RAW_PRESETS: "false"
      PHOTOPRISM_JPEG_QUALITY: 85
      PHOTOPRISM_DETECT_NSFW: "false"
      PHOTOPRISM_UPLOAD_NSFW: "true"
      PHOTOPRISM_DATABASE_DRIVER: "mysql"
      PHOTOPRISM_DATABASE_SERVER: "photoprism-db:3306"
      PHOTOPRISM_DATABASE_NAME: "${PHOTOPRISM_DB_NAME:-photoprism}"
      PHOTOPRISM_DATABASE_USER: "${PHOTOPRISM_DB_USER:-photoprism}"
      PHOTOPRISM_DATABASE_PASSWORD: "${PHOTOPRISM_DB_PASSWORD}"
      PHOTOPRISM_SITE_CAPTION: "AI-Powered Photos App"
      PHOTOPRISM_SITE_DESCRIPTION: ""
      PHOTOPRISM_SITE_AUTHOR: ""
    working_dir: "/photoprism"
    volumes:
      - photoprism-originals:/photoprism/originals
      - photoprism-storage:/photoprism/storage
    networks:
      - freddy-net
    depends_on:
      - photoprism-db
    healthcheck:
      test: ["CMD", "photoprism", "status"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 60s

  photoprism-db:
    image: mariadb:11
    container_name: photoprism-db
    restart: unless-stopped
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    command: --innodb-buffer-pool-size=512M --transaction-isolation=READ-COMMITTED --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci --max-connections=512 --innodb-rollback-on-timeout=OFF --innodb-lock-wait-timeout=120
    environment:
      MARIADB_AUTO_UPGRADE: "1"
      MARIADB_INITDB_SKIP_TZINFO: "1"
      MARIADB_DATABASE: "${PHOTOPRISM_DB_NAME:-photoprism}"
      MARIADB_USER: "${PHOTOPRISM_DB_USER:-photoprism}"
      MARIADB_PASSWORD: "${PHOTOPRISM_DB_PASSWORD}"
      MARIADB_ROOT_PASSWORD: "${PHOTOPRISM_DB_ROOT_PASSWORD}"
    volumes:
      - photoprism-db:/var/lib/mysql
    networks:
      - freddy-net
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ==========================================================================
  # NEXTCLOUD - Cloud Storage
  # ==========================================================================
  nextcloud:
    image: nextcloud:latest
    container_name: nextcloud
    restart: unless-stopped
    environment:
      MYSQL_HOST: nextcloud-db
      MYSQL_DATABASE: "${NEXTCLOUD_DB_NAME:-nextcloud}"
      MYSQL_USER: "${NEXTCLOUD_DB_USER:-nextcloud}"
      MYSQL_PASSWORD: "${NEXTCLOUD_DB_PASSWORD}"
      NEXTCLOUD_ADMIN_USER: "${NEXTCLOUD_ADMIN_USER:-admin}"
      NEXTCLOUD_ADMIN_PASSWORD: "${NEXTCLOUD_ADMIN_PASSWORD}"
      NEXTCLOUD_TRUSTED_DOMAINS: "nc.7gram.xyz localhost"
      OVERWRITEPROTOCOL: "https"
      OVERWRITEHOST: "nc.7gram.xyz"
      OVERWRITECLIURL: "https://nc.7gram.xyz"
    volumes:
      - nextcloud-data:/var/www/html
      - nextcloud-config:/var/www/html/config
      - nextcloud-apps:/var/www/html/custom_apps
      - nextcloud-files:/var/www/html/data
    networks:
      - freddy-net
    depends_on:
      - nextcloud-db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/status.php"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  nextcloud-db:
    image: mariadb:11
    container_name: nextcloud-db
    restart: unless-stopped
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW
    environment:
      MARIADB_AUTO_UPGRADE: "1"
      MARIADB_DATABASE: "${NEXTCLOUD_DB_NAME:-nextcloud}"
      MARIADB_USER: "${NEXTCLOUD_DB_USER:-nextcloud}"
      MARIADB_PASSWORD: "${NEXTCLOUD_DB_PASSWORD}"
      MARIADB_ROOT_PASSWORD: "${NEXTCLOUD_DB_ROOT_PASSWORD}"
    volumes:
      - nextcloud-db:/var/lib/mysql
    networks:
      - freddy-net
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  # ==========================================================================
  # HOME ASSISTANT - Home Automation
  # ==========================================================================
  homeassistant:
    image: ghcr.io/home-assistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    privileged: true
    environment:
      TZ: "${TIMEZONE:-America/New_York}"
    volumes:
      - homeassistant-config:/config
      - /etc/localtime:/etc/localtime:ro
    networks:
      - freddy-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ==========================================================================
  # AUDIOBOOKSHELF - Audiobook Server
  # ==========================================================================
  audiobookshelf:
    image: ghcr.io/advplyr/audiobookshelf:latest
    container_name: audiobookshelf
    restart: unless-stopped
    environment:
      TZ: "${TIMEZONE:-America/New_York}"
    volumes:
      - audiobookshelf-config:/config
      - audiobookshelf-metadata:/metadata
      - audiobookshelf-audiobooks:/audiobooks
      - audiobookshelf-podcasts:/podcasts
    networks:
      - freddy-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

# ============================================================================
# NETWORKS
# ============================================================================
networks:
  freddy-net:
    name: freddy-net
    driver: bridge

# ============================================================================
# VOLUMES
# ============================================================================
volumes:
  # SSL Certificates (external - created and managed by CI/CD)
  ssl-certs:
    external: true
    name: ssl-certs

  # PhotoPrism
  photoprism-originals:
    driver: local
  photoprism-storage:
    driver: local
  photoprism-db:
    driver: local

  # Nextcloud
  nextcloud-data:
    driver: local
  nextcloud-config:
    driver: local
  nextcloud-apps:
    driver: local
  nextcloud-files:
    driver: local
  nextcloud-db:
    driver: local

  # Home Assistant
  homeassistant-config:
    driver: local

  # Audiobookshelf
  audiobookshelf-config:
    driver: local
  audiobookshelf-metadata:
    driver: local
  audiobookshelf-audiobooks:
    driver: local
  audiobookshelf-podcasts:
    driver: local
